# Requirements Document

## Project Description (Input)
グループ参加・招待機能

## 背景
現在、ユーザーはオンボーディング時に新しいグループを作成することができますが、既存のグループに参加したり、他のユーザーをグループに招待する機能がありません。服薬管理アプリの性質上、家族や介護者が同じグループに参加して服薬状況を共有する必要があります。

## 現状の実装
- groups テーブル: グループ基本情報（name, description, createdBy, createdAt）
- groupMembers テーブル: メンバーシップ情報（groupId, userId, displayName, role, joinedAt）
- role は「patient（患者）」または「supporter（サポーター）」
- オンボーディング時のグループ作成機能のみ実装済み（completeOnboardingWithNewGroup）
- joinGroup mutation が存在するが、現在は使われていない

## 目的
既存のグループに他のユーザーが参加できる仕組みを実装し、家族や介護者が同じグループで服薬情報を共有できるようにする。

## 主要な要件
1. グループへの招待機能
   - グループメンバーが他のユーザーを招待できる
   - 招待方法（招待コード、リンク、メールアドレスなど）の検討
   - 招待の有効期限管理
   - **重要な制約**: 1グループ内にpatientは常に1人のみ
     - patient不在時のみ、patientとしての招待が可能
     - patientが既に存在する場合は、supporterとしての招待のみ可能

2. グループ参加機能
   - 招待を受けたユーザーが参加できる
   - 参加時のロール選択（patient/supporter）
     - グループのpatient在籍状況に応じて選択肢を制限
   - 参加承認フロー（自動承認 vs 管理者承認）

3. セキュリティとプライバシー
   - 招待権限の管理（全メンバー vs 特定ロールのみ）
   - グループ情報の公開範囲
   - 不正な参加の防止

4. ユーザビリティ
   - 簡単に招待できるUI/UX
   - モバイルでの共有のしやすさ
   - 招待状態の確認

## 技術スタック
- Convex（バックエンド）
- Next.js 15 + React 19（フロントエンド）
- Convex Auth（認証）
- TypeScript

## Requirements

### Requirement 1: 招待コード生成と管理
**目的:** グループメンバーとして、他のユーザーを安全かつ簡単にグループに招待できるようにすることで、家族や介護者との服薬情報共有を実現する。

#### 受け入れ基準
1. WHEN 認証済みグループメンバーが招待コード生成をリクエストした場合 THEN おくすりサポートは一意な招待コードを生成しなければならない
2. WHEN 招待コードが生成された場合 AND グループにpatientが不在の場合 THEN おくすりサポートは招待可能ロールとして「patient」と「supporter」の両方を許可しなければならない
3. WHEN 招待コードが生成された場合 AND グループに既にpatientが存在する場合 THEN おくすりサポートは招待可能ロールを「supporter」のみに制限しなければならない
4. WHEN 招待コードが生成された場合 THEN おくすりサポートは有効期限（7日間）を設定しなければならない
5. WHEN 招待コードの有効期限が過ぎた場合 THEN おくすりサポートは該当コードを無効化しなければならない
6. WHERE グループメンバー管理画面で THE おくすりサポートは生成済み招待コードの一覧（コード、有効期限、作成者、招待可能ロール）を表示しなければならない

### Requirement 2: 招待コードによるグループ参加
**目的:** 招待を受けたユーザーとして、招待コードを使用してグループに参加できるようにすることで、服薬管理の協働体制を構築する。

#### 受け入れ基準
1. WHEN 認証済みユーザーが有効な招待コードを入力した場合 THEN おくすりサポートは該当グループの基本情報（グループ名、説明、現在のメンバー数）を表示しなければならない
2. WHEN ユーザーが招待コードで参加を試みた場合 AND ユーザーが既にそのグループのメンバーである場合 THEN おくすりサポートはエラーメッセージ「既にこのグループのメンバーです」を表示しなければならない
3. WHEN ユーザーがロールを選択して参加確認をした場合 AND 選択したロールが招待コードの許可ロールに含まれる場合 THEN おくすりサポートはユーザーをグループメンバーとして追加しなければならない
4. WHEN ユーザーがpatientロールを選択した場合 AND グループに既にpatientが存在する場合 THEN おくすりサポートはエラーメッセージ「このグループには既に患者が登録されています」を表示し参加を拒否しなければならない
5. WHEN ユーザーがグループに参加した場合 THEN おくすりサポートは参加日時（joinedAt）とユーザー表示名（displayName）を記録しなければならない
6. WHEN 無効な招待コード（存在しない、期限切れ、または既に使用済み）が入力された場合 THEN おくすりサポートはエラーメッセージ「招待コードが無効です」を表示しなければならない

### Requirement 3: 招待リンクの共有
**目的:** グループメンバーとして、モバイル環境で簡単に招待を共有できるようにすることで、招待プロセスのユーザビリティを向上させる。

#### 受け入れ基準
1. WHEN グループメンバーが招待コードを生成した場合 THEN おくすりサポートは招待コードを含む招待リンク（`https://[app-domain]/invite/[code]`）を生成しなければならない
2. WHERE 招待コード表示画面で THE おくすりサポートは招待リンクをコピーするボタンを提供しなければならない
3. WHEN ユーザーが招待リンクコピーボタンをクリックした場合 THEN おくすりサポートは招待リンクをクリップボードにコピーし、確認トースト通知を表示しなければならない
4. WHERE モバイル環境で THE おくすりサポートはネイティブ共有機能（Web Share API）を使用した共有ボタンを提供しなければならない
5. WHEN ユーザーが招待リンクにアクセスした場合 AND ユーザーが未認証の場合 THEN おくすりサポートはログイン画面にリダイレクトし、認証後に招待受け入れ画面に戻さなければならない

### Requirement 4: 招待権限の管理
**目的:** グループの安全性を確保するために、招待コード生成権限を適切に制御する。

#### 受け入れ基準
1. WHEN 認証済みユーザーが招待コード生成をリクエストした場合 AND ユーザーがグループメンバーでない場合 THEN おくすりサポートはエラーメッセージ「このグループのメンバーではありません」を表示し生成を拒否しなければならない
2. WHEN グループメンバーが招待コード生成をリクエストした場合 THEN おくすりサポートは全メンバー（patientとsupporter両方）に招待権限を付与しなければならない
3. WHERE 招待コード生成時 THE おくすりサポートは作成者のuserIdを記録しなければならない

### Requirement 5: グループ参加状態の管理
**目的:** ユーザーがグループ参加状況を明確に把握できるようにすることで、混乱を防ぎ適切なアクションを促す。

#### 受け入れ基準
1. WHERE ダッシュボード画面で THE おくすりサポートはユーザーの所属グループ一覧（グループ名、ロール、参加日時）を表示しなければならない
2. WHEN ユーザーがどのグループにも所属していない場合 THEN おくすりサポートは「新しいグループを作成」と「招待コードで参加」の選択肢を表示しなければならない
3. WHERE グループメンバー一覧画面で THE おくすりサポートは各メンバーの表示名、ロール、参加日時を表示しなければならない
4. WHERE グループメンバー一覧画面で THE おくすりサポートはpatientロールのメンバーを視覚的に区別可能（バッジ表示など）にしなければならない

### Requirement 6: データ整合性とセキュリティ
**目的:** グループデータの整合性を維持し、不正アクセスを防止する。

#### 受け入れ基準
1. WHEN グループに新しいpatientが参加しようとした場合 AND グループに既にpatientが存在する場合 THEN おくすりサポートはトランザクション的に参加処理を拒否しなければならない
2. WHEN 招待コードが使用された場合 THEN おくすりサポートは使用回数を記録しなければならない
3. WHILE ユーザーがグループデータにアクセスしている間 THE おくすりサポートはユーザーがそのグループのメンバーであることを検証しなければならない
4. WHEN 招待コードが生成される場合 THEN おくすりサポートは暗号学的に安全なランダム文字列（最低8文字、英数字）を使用しなければならない
5. WHERE Convexバックエンド関数で THE おくすりサポートは全ての招待・参加操作において認証状態（userId）を検証しなければならない
