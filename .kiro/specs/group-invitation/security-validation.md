# セキュリティ検証レポート - グループ招待機能

**作成日**: 2025-10-12  
**Phase**: Phase 5 - Task 19

## 19.1 招待コードの総当たり攻撃耐性

### 招待コードの仕様

- **形式**: 8文字英数字（大文字のみ）
- **文字セット**: A-Z (26文字) + 0-9 (10文字) = 36文字
- **組み合わせ総数**: 36^8 = 2,821,109,907,456 (約2.8兆通り)

### 攻撃耐性の評価

#### 総当たり攻撃（Brute Force）のコスト計算

**前提条件**:
- 攻撃者が1秒間に1,000回のリクエストを送信できると仮定
- 全組み合わせを試すのに必要な時間:
  - 2,821,109,907,456 / 1,000 = 2,821,109,907秒
  - 約89年

**結論**: 総当たり攻撃は実質的に不可能

#### ランダム推測攻撃の成功確率

**シナリオ1**: 1,000万回の試行
- 成功確率: 10,000,000 / 2,821,109,907,456 ≈ 0.00035%
- 極めて低い

**シナリオ2**: 10億回の試行（組織的攻撃）
- 成功確率: 1,000,000,000 / 2,821,109,907,456 ≈ 0.035%
- 依然として低い

### 有効期限による追加保護

- **有効期限**: 7日間
- 攻撃者は7日以内に当てる必要がある
- 期限切れ後は新しいコードが必要になる

**評価**: ✅ 有効期限7日間は適切

### 現状の保護メカニズム

1. **一意性制約**: データベースレベルで招待コードの重複を防止
2. **使用済みフラグ**: 1回のみ使用可能
3. **有効期限**: 7日間で自動失効
4. **Patient制約**: グループあたり1人のPatientのみ

### 推奨事項

#### 短期的な対策（実装済み）
- ✅ 8文字英数字の招待コード
- ✅ 7日間の有効期限
- ✅ 1回限りの使用制限
- ✅ データベースレベルの一意性制約

#### 中期的な対策（将来の検討事項）
1. **レートリミット**
   - 目的: 大量の検証リクエストを防止
   - 実装案:
     - IP単位: 1分間に10回まで
     - ユーザー単位: 1時間に100回まで
   - 優先度: 中（現状の攻撃耐性で十分だが、監視は推奨）

2. **監視とアラート**
   - 異常な検証リクエスト数の検知
   - 失敗率が高いIPアドレスのロギング
   - 優先度: 低（初期段階では不要）

3. **CAPTCHA**
   - 短時間に複数回失敗した場合のCHAPTCHA表示
   - 優先度: 低（レートリミット実装後に検討）

#### 長期的な対策（スケール後）
1. **WAF（Web Application Firewall）**
   - DDoS攻撃の防止
   - 優先度: 低（ユーザー規模拡大後）

2. **機械学習ベースの異常検知**
   - 攻撃パターンの自動識別
   - 優先度: 低（大規模運用時）

## 19.2 認証・認可の全層での検証

### フロントエンド（Next.js）

#### 認証状態チェック
- **実装箇所**: 
  - `src/app/invite/[code]/page.tsx`
  - Server Componentで`convex.auth.getUserId()`を使用
  - 未認証の場合は自動的に認証ページへリダイレクト

**検証結果**: ✅ 適切に実装済み

```typescript
// 例: src/app/invite/[code]/page.tsx
const userId = await convex.auth.getUserId();
if (!userId) {
  redirect("/login");
}
```

#### UI層での保護
- **実装箇所**: グループ管理画面、招待コード生成ページ
- Server Componentによる認証状態の事前チェック
- 認証済みユーザーのみがアクセス可能

**検証結果**: ✅ 適切に実装済み

### バックエンド（Convex）

#### 全mutationでの認証確認

**検証対象mutation**:
1. `createInvitationInternal` - 招待コード生成
2. `joinGroupWithInvitation` - 招待コードでの参加
3. `joinGroup` - 通常のグループ参加
4. `completeOnboardingWithNewGroup` - オンボーディング

**検証方法**: 統合テストで確認済み
- ✅ 未認証ユーザーは全mutationでエラー
- ✅ 認証済みユーザーのみが操作可能

**検証結果**: ✅ 全層で適切に実装済み

#### グループメンバーシップの検証

**検証ポイント**:
1. 招待コード生成: グループメンバーのみ実行可能
2. 招待一覧取得: グループメンバーのみ実行可能
3. グループ参加: Patient制約の適切な適用

**実装箇所**: 
- `convex/invitations/mutations.ts`
- `convex/invitations/queries.ts`
- `convex/groups/mutations.ts`

**検証結果**: ✅ 統合テストで全て確認済み

### セキュリティ実装のまとめ

| セキュリティ要件 | 実装状況 | 検証方法 | 結果 |
|-----------------|---------|---------|------|
| フロントエンド認証チェック | ✅ 実装済み | Server Component | ✅ Pass |
| バックエンド認証チェック | ✅ 実装済み | 統合テスト | ✅ Pass |
| グループメンバーシップ検証 | ✅ 実装済み | 統合テスト | ✅ Pass |
| Patient制約の適用 | ✅ 実装済み | ユニット/統合テスト | ✅ Pass |
| 招待コードの一意性 | ✅ 実装済み | データベース制約 | ✅ Pass |
| 招待コードの使用済み管理 | ✅ 実装済み | 統合テスト | ✅ Pass |
| 有効期限チェック | ✅ 実装済み | ユニット/統合テスト | ✅ Pass |

### 既知の制限事項

1. **レートリミット未実装**
   - 影響: 大量の検証リクエストが可能（ただし成功確率は極めて低い）
   - 対策: 中期的に実装を検討
   - リスクレベル: 低

2. **監視・アラート未実装**
   - 影響: 異常なアクセスパターンの検知が手動
   - 対策: 長期的に実装を検討
   - リスクレベル: 低

### 総合評価

**セキュリティレベル**: ✅ 高

グループ招待機能は以下の観点で十分なセキュリティを確保している:

1. **認証**: 全層で適切に実装され、統合テストで検証済み
2. **認可**: グループメンバーシップの検証が適切に機能
3. **攻撃耐性**: 招待コードの総当たり攻撃は実質的に不可能
4. **データ整合性**: Patient制約と使用済み管理で保護

現状の実装で本番環境への展開が可能。レートリミットと監視は将来の機能拡張として計画すれば十分。

## 推奨アクションアイテム

### 即座に実施
- なし（現状で十分）

### 3ヶ月以内
- [ ] 招待コード検証のアクセスログ分析（手動）
- [ ] 異常パターンの有無を確認

### 6ヶ月以内（ユーザー数増加後）
- [ ] レートリミットの実装
- [ ] 基本的な監視ダッシュボードの構築

### 1年以内（スケール後）
- [ ] WAFの導入
- [ ] 高度な異常検知システムの検討

---

**検証完了日**: 2025-10-12  
**検証者**: AI Agent (Claude Code)  
**次回レビュー予定**: サービス開始3ヶ月後
