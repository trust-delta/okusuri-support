# Claude Code 開発ルール

AI実行精度最大化のための中核ルール。全ての指示はこのファイルに従う。

## 🚨 最重要原則：調査OK、実装STOP

**すべてのEdit/Write/MultiEditツール使用前にユーザー承認が必須**

理由：ユーザーの意図と異なる実装を防ぎ、正しい方向性を確保するため

## 必須実行プロセス

### 実行フロー（必須手順）
1. **TodoWriteでタスク分解** → なければ実装ステップに進めない
   理由：タスクを構造化し、進捗を追跡可能にするため
2. **rule-advisor実行** → タスクの本質を理解し適切なルールを選択
   理由：適切なルールを選択し、タスクの本質を理解するため
3. **Edit/Write/MultiEdit使用** → ユーザー承認が必須
   理由：最重要原則の実践（調査OK、実装STOP）
4. **実装実行** → 品質チェックエラーは完了条件を満たさない
   理由：高品質なコードを保証するため
5. **ファイル数カウント** → 閾値超過で自動停止
   理由：影響範囲が大きくなる前に確認を取るため

### TodoWriteとメタ認知の統合
**実行ルール**：
- `pending → in_progress`時: rule-advisorの出力が必須
- **rule-advisor実行後**: 必ずTodoWriteを更新（タスク内容・優先度・分解粒度の見直し）
  - taskEssenceに基づいてタスク説明を具体化
  - firstActionGuidanceを最初のタスクに反映
  - warningPatternsを考慮してタスクを再構成
- TodoWriteなしでEditツール使用: ルール違反として停止
- 各タスクのステータス更新時: 実施内容の記録を必須化（空白不可）

### 実行前提条件
1. **rule-advisorの出力** → JSONレスポンスが存在すること
2. **TodoWriteのタスク** → in_progressステータスが存在すること
3. **ユーザー承認記録** → Edit/Write前に明示的承認があること
4. **品質チェック結果** → エラー0でなければ完了不可

### 禁止事項
- **any型使用** → 型チェックエラーの原因
  理由：型安全性を破壊し、実行時エラーを引き起こすため
- **TodoWriteなしのEdit使用** → ルール違反
  理由：タスク管理なしでは進捗追跡と品質保証ができないため
- **承認なしEdit/Write/MultiEdit** → 承認待ちに移行
  理由：最重要原則（調査OK、実装STOP）の違反を防ぐため
- **品質エラー残存での完了宣言** → 完了条件を満たさない
  理由：不完全なコードの混入を防ぐため

## メタ認知実行（タスク開始時必須）

### rule-advisorから取得した情報でメタ認知
1. **taskEssence（タスクの本質）を理解**
   - 表面的な作業内容と根本目的の区別
   - 「quick fix」vs「proper solution」の判定

2. **applicableRules（適用ルール）を確認**
   - 選択されたルールが適切か判断
   - 必要なセクションを読み込む

3. **pastFailurePatterns（過去の失敗）を認識**
   - 同じ失敗を繰り返さないよう注意
   - 提示された回避策を意識

4. **firstAction（初動アクション）を実行**
   - 推奨されたツールから開始
   - 計画的に進める

## Claude行動制御（失敗防止）

### 自動停止トリガー（必ず停止）
- **5ファイル以上の変更検出**：即座停止、影響範囲をユーザーに報告
  理由：大規模変更は事前計画とレビューが必要なため
- **同じエラー3回発生**：根本原因分析必須
  理由：対症療法ではなく根本解決が必要なため
- **unknown型多用検出**：型ガード設計再検討
  理由：型安全性の設計に問題がある可能性が高いため
- **3ファイル編集完了**: TodoWriteの更新を強制（更新しないと次のEditツール使用不可）
  理由：進捗確認と方向性の再確認が必要なため

### エラー修正衝動対処
1. エラー発見 → **一時停止**
2. rule-advisor再実行
3. 根本原因分析（なぜ？を5回繰り返して真因を特定）
4. 対処計画提示
5. ユーザー承認後に修正

### エスカレーション基準（ユーザー確認必須）
- アーキテクチャ変更（新レイヤー追加、責務変更）
- 外部依存追加（npmパッケージ、外部API）
- 破壊的変更（既存APIの変更、データ構造の変更）
- 複数の実装方法があり優劣が判断できない場合

### 集中時のルール無視防止
**測定可能な強制停止基準**：
- **連続エラー修正2回目**: 自動的にrule-advisor再実行をトリガー
- **Editツール5回使用**: 影響範囲レポートの作成を強制
- **同一ファイル3回編集**: リファクタリング検討の強制停止

### 一時ファイル作成ルール
作業中ファイルは`tmp/`ディレクトリ使用。完了時削除。

### 専門エージェント積極活用（PROACTIVELY）
- **品質関連キーワード検出時**: quality-fixer必須実行
  - 型エラー、ビルドエラー、lintエラー、フォーマット警告
  - テスト失敗、品質チェック、検証タスク
- **タスク開始時**: rule-advisor必須実行
  - TodoWrite作成前に実行し、結果を反映

## rule-advisor使用法

### 実行方法（例）
Taskツールを使用してrule-advisorを呼び出す際の例：
- subagent_type: "rule-advisor"
- description: タスクの簡潔な説明
- prompt: "@rule-advisor タスク: [具体的なタスク内容] コンテキスト: [現在の状況や前提条件] 適切なルールセットを選択してください。"

### 出力の活用
出力にはセクション内容が含まれるため、具体的なルールを直接参照可能：
```json
{
  "selectedRules": [{
    "sections": [{
      "title": "型システムの活用",
      "content": "実際のルール内容が含まれる"
    }]
  }],
  "mandatoryChecks": {
    "taskEssence": "型安全性の確保（エラー消しではない）",
    "firstStep": "具体的な初動アクション"
  }
}
```