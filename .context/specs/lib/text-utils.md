# テキスト正規化ユーティリティ仕様

**最終更新**: 2025年11月17日

## 概要

テキストの正規化、切り詰め、サニタイズなどの汎用的な文字列処理を提供するユーティリティライブラリ。ユーザー入力の正規化やUI表示用のテキスト処理に使用されます。

---

## ユースケース

### 主要シナリオ

**シナリオ1: グループ名・薬剤名の入力正規化**
1. ユーザーが全角英数字を含むグループ名「グループ ABC」を入力
2. `normalizeText`で「グループ ABC」に正規化（全角ABC→半角ABC）
3. データベースに一貫した形式で保存され、検索時の不整合を防ぐ

**シナリオ2: 服薬記録のメモ入力時のサニタイズ**
1. ユーザーがメモ欄に `<script>alert('XSS')</script>` を含むテキストを入力
2. `sanitizeInput`でHTMLタグを除去し、危険な文字をエスケープ
3. XSS攻撃を防ぎ、安全にデータベースに保存

**シナリオ3: 長い薬剤名の切り詰め表示**
1. 統計画面で長い薬剤名「アムロジピンベシル酸塩錠5mg『サワイ』」を表示
2. `truncateText`で「アムロジピンベシル酸塩...」に切り詰め
3. 画面レイアウトを崩さず、読みやすく表示

---

## 機能要件

### テキスト正規化

#### normalizeText
- **説明**: 全角英数字を半角に変換し、前後の空白をトリム、連続する空白を1つに統一。ユーザー入力を一貫した形式に正規化する。
- **優先度**: 高
- **実装状況**: 完了
- **使用例**:
  ```typescript
  normalizeText("  Hello   World  ");    // => "Hello World"
  normalizeText("Hello\u3000World");     // => "Hello World" (全角スペース→半角)
  normalizeText("ＡＢＣ１２３");          // => "ABC123" (全角→半角)
  normalizeText("グループ　ＡＢＣ  ");   // => "グループ ABC"
  ```

### テキスト切り詰め

#### truncateText
- **説明**: テキストを指定文字数で切り詰め、サフィックスを追加。UI上で長いテキストを省略表示する際に使用。
- **優先度**: 高
- **実装状況**: 完了
- **使用例**:
  ```typescript
  truncateText("こんにちは、世界", 5);         // => "こんに..."
  truncateText("短い", 10);                    // => "短い"
  truncateText("長いテキスト", 5, "…");        // => "長いテ…"
  truncateText("アムロジピンベシル酸塩錠5mg『サワイ』", 15);  // => "アムロジピンベシル..."
  ```

### 入力サニタイズ

#### sanitizeInput
- **説明**: HTMLタグの除去と基本的なXSS対策を実施。ユーザー入力を表示する前に使用し、セキュリティリスクを軽減。
- **優先度**: 高
- **実装状況**: 完了
- **使用例**:
  ```typescript
  sanitizeInput("<script>alert('XSS')</script>");  // => ""
  sanitizeInput("<b>太字</b>テキスト");            // => "太字テキスト"
  sanitizeInput("通常のテキスト");                  // => "通常のテキスト"
  sanitizeInput("<img src=x onerror=alert(1)>");   // => ""
  ```

---

## 技術仕様

### ファイル構成

```
app/_shared/lib/text-utils.ts
```

### 関数シグネチャ

#### normalizeText
```typescript
export function normalizeText(text: string): string
```

**パラメータ**:
- `text`: 正規化対象のテキスト

**戻り値**: 正規化されたテキスト

**実装詳細**:
1. 全角英数字を半角に変換（`String.fromCharCode(char.charCodeAt(0) - 0xfee0)`）
2. 全角スペース（`\u3000`）を半角スペースに変換
3. 前後の空白をトリム（`.trim()`）
4. 連続する空白を1つに統一（`.replace(/\s+/g, " ")`）

**処理順序の重要性**:
- 全角→半角変換を先に実行することで、全角スペースも適切に処理
- トリムは最後に実行し、不要な空白を確実に除去

#### truncateText
```typescript
export function truncateText(
  text: string,
  maxLength: number,
  suffix = "..."
): string
```

**パラメータ**:
- `text`: 切り詰め対象のテキスト
- `maxLength`: 最大文字数（サフィックスを含む）
- `suffix`: 切り詰め時に追加するサフィックス（デフォルト: `"..."`）

**戻り値**: 切り詰められたテキスト

**実装詳細**:
1. `text.length <= maxLength` の場合はそのまま返す（切り詰め不要）
2. `truncatedLength = maxLength - suffix.length` で実際の切り詰め位置を計算
3. `text.slice(0, truncatedLength) + suffix` で切り詰めとサフィックス追加

**注意点**:
- `maxLength`にはサフィックスの長さも含まれる
- 例: `truncateText("あいうえお", 5)` → `"あい..."` （2文字 + 3文字のサフィックス = 5文字）

#### sanitizeInput
```typescript
export function sanitizeInput(text: string): string
```

**パラメータ**:
- `text`: サニタイズ対象のテキスト

**戻り値**: サニタイズされたテキスト

**実装詳細**:
1. HTMLタグを除去（`.replace(/<[^>]*>/g, "")`）
2. 危険な文字をHTMLエンティティにエスケープ:
   - `&` → `&amp;`
   - `<` → `&lt;`
   - `>` → `&gt;`
   - `"` → `&quot;`
   - `'` → `&#x27;`
   - `/` → `&#x2F;`

**セキュリティ考慮事項**:
- 基本的なXSS対策を提供（より高度な対策は別途検討）
- タグ除去→エスケープの順で処理
- ユーザー入力を**表示前**に必ずサニタイズする

---

## ビジネスルール

### 正規化ルール

1. **全角英数字の半角変換**:
   - 対象: A-Z, a-z, 0-9
   - 例: `ＡＢＣ` → `ABC`, `１２３` → `123`

2. **空白の統一**:
   - 全角スペース（`\u3000`）→ 半角スペース
   - 連続する空白 → 1つの半角スペース
   - 前後の空白 → トリム

3. **日本語テキストの保持**:
   - ひらがな、カタカナ、漢字はそのまま保持
   - 例: `グループ　ＡＢＣ` → `グループ ABC`

### 切り詰めルール

1. **文字数カウント**:
   - 日本語1文字 = 英数字1文字 = 1カウント
   - サフィックスの長さも含めて`maxLength`以内に収める

2. **サフィックスのカスタマイズ**:
   - デフォルト: `"..."`（3文字）
   - 日本語環境では `"…"`（1文字）も選択可能

### サニタイズルール

1. **HTMLタグの除去**:
   - すべてのHTMLタグを削除（`<script>`, `<img>`, `<b>` など）

2. **特殊文字のエスケープ**:
   - HTML/JavaScriptで特殊な意味を持つ文字をエスケープ
   - XSS攻撃の基本的な防御

3. **適用タイミング**:
   - ユーザー入力を受け取った直後（保存前）
   - データベースから取得した後、表示前（多重防御）

---

## 使用箇所

### 現在の使用箇所

（実装後に追加予定）

### 想定される使用箇所

1. **グループ作成・編集フォーム**:
   - グループ名入力時に`normalizeText`で正規化
   - 説明文入力時に`sanitizeInput`でサニタイズ

2. **薬剤登録フォーム**:
   - 薬剤名入力時に`normalizeText`で正規化
   - メモ欄に`sanitizeInput`を適用

3. **服薬記録フォーム**:
   - メモ欄の入力を`sanitizeInput`でサニタイズ
   - 簡易薬剤名を`normalizeText`で正規化

4. **統計画面・ダッシュボード**:
   - 長い薬剤名を`truncateText`で切り詰め表示
   - グループ名の長さ制限

5. **ユーザープロフィール**:
   - 表示名の正規化（`normalizeText`）
   - 自己紹介文のサニタイズ（`sanitizeInput`）

---

## パフォーマンス要件

- **処理速度**: 単一テキストの処理は1ms未満
- **メモリ使用量**: 最小限（文字列生成のみ）
- **副作用**: なし（純粋関数）

### 最適化戦略

1. **正規表現の最小化**: 必要最小限の正規表現のみ使用
2. **メソッドチェーン**: `.replace()`チェーンで効率的に処理
3. **早期リターン**: `truncateText`で切り詰め不要時は即座に返す
4. **ステートレス**: すべて純粋関数として実装

---

## セキュリティ要件

### XSS対策

1. **基本的な防御**:
   - `sanitizeInput`でHTMLタグを除去
   - 危険な文字をエスケープ

2. **多重防御**:
   - 入力時のサニタイズ + 出力時のエスケープ
   - React/Next.jsの自動エスケープと併用

3. **制限事項**:
   - このライブラリは基本的なXSS対策のみ提供
   - より高度なセキュリティが必要な場合は別途ライブラリ検討（例: DOMPurify）

### データ整合性

1. **一貫した正規化**:
   - すべてのユーザー入力に`normalizeText`を適用
   - データベース内のテキスト形式を統一

2. **検索の精度向上**:
   - 正規化により、全角・半角の違いによる検索ミスを防ぐ

---

## テスト要件

### ユニットテスト

#### normalizeText
- [ ] 全角英数字の半角変換（`ＡＢＣ１２３` → `ABC123`）
- [ ] 全角スペースの半角変換（`Hello\u3000World` → `Hello World`）
- [ ] 前後の空白トリム（`"  Hello  "` → `"Hello"`）
- [ ] 連続空白の統一（`"Hello   World"` → `"Hello World"`）
- [ ] 日本語の保持（`グループ　ＡＢＣ` → `グループ ABC`）
- [ ] 空文字列の処理
- [ ] 記号の保持（`"Hello-World!"` → `"Hello-World!"`）

#### truncateText
- [ ] 基本的な切り詰め（`"こんにちは、世界"`, 5 → `"こんに..."`）
- [ ] 切り詰め不要な場合（`"短い"`, 10 → `"短い"`）
- [ ] カスタムサフィックス（`"長いテキスト"`, 5, `"…"` → `"長いテ…"`）
- [ ] maxLengthがサフィックス長以下の場合
- [ ] 空文字列の処理
- [ ] maxLength = 0の処理

#### sanitizeInput
- [ ] HTMLタグの除去（`<script>alert('XSS')</script>` → ``）
- [ ] 複数タグの除去（`<b>太字</b>テキスト` → `太字テキスト`）
- [ ] 危険な文字のエスケープ（`&<>"'/`）
- [ ] 通常のテキストはそのまま（`通常のテキスト` → `通常のテキスト`）
- [ ] ネストしたタグ（`<div><span>text</span></div>`）
- [ ] 不完全なタグ（`<script`）
- [ ] 空文字列の処理

テスト実装: `app/_shared/lib/__tests__/text-utils.test.ts`（作成予定）

---

## 依存関係

### 内部依存
なし（他のユーティリティに依存しない）

### 外部依存
なし（標準JavaScriptのみ使用）

---

## 関連ドキュメント

- [number-utils.md](./number-utils.md) - 数値フォーマットユーティリティ
- [コーディングスタイルガイド](../../coding-style.md)
- [エラーハンドリング](../../error-handling.md)
- [プロジェクト概要](../../project.md)

---

## 実装ファイル

**パス**: `app/_shared/lib/text-utils.ts`

**エクスポート関数**:
- `normalizeText(text: string): string`
- `truncateText(text: string, maxLength: number, suffix?: string): string`
- `sanitizeInput(text: string): string`

---

## 既知の課題

### 今後の改善候補

1. **より高度なXSS対策**:
   - 現在は基本的なサニタイズのみ
   - 将来的にDOMPurifyなどの専門ライブラリ導入を検討

2. **Unicode正規化**:
   - 現在は全角英数字のみ対応
   - 将来的にはUnicode正規化（NFD/NFC）の検討

3. **言語別の切り詰めロジック**:
   - 現在は単純な文字数ベース
   - 将来的には単語境界を考慮した切り詰め（英語など）

---

## 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|----------|--------|
| 2025年11月17日 | 初版作成（normalizeText, truncateText, sanitizeInput） | spec-assistant |
