# PDFレポート出力機能仕様

**最終更新**: 2026年1月11日

## 概要

服薬統計データをPDF形式で出力し、医師への提出や支援者との共有を可能にする機能。既存の統計機能のデータを活用し、見やすいレポート形式で出力する。

---

## ユースケース

### 主要シナリオ

**シナリオ1: 通院時に医師へ服薬状況を報告**
1. 患者または支援者が統計画面を開く
2. レポート出力期間（過去1ヶ月など）を選択
3. 「PDFをダウンロード」ボタンをクリック
4. PDFファイルがダウンロードされる
5. 通院時に医師に提出

**シナリオ2: 遠方の家族に服薬状況を共有**
1. 支援者が統計画面を開く
2. レポート出力期間を選択
3. 「PDFをダウンロード」ボタンをクリック
4. ダウンロードしたPDFをメールやLINEで家族に送信

**シナリオ3: 定期的な服薬記録の保存**
1. 月末に患者または支援者が統計画面を開く
2. 「今月」を期間として選択
3. PDFをダウンロードしてローカルに保存
4. 長期的な服薬履歴として保管

---

## 機能要件

### レポート生成

#### 期間選択
- **説明**: レポート対象期間を選択
- **優先度**: 高
- **実装状況**: 未実装
- **オプション**:
  - 過去7日間
  - 過去30日間
  - 今月
  - 先月
  - カスタム期間（開始日〜終了日）

#### PDFダウンロード
- **説明**: 選択した期間の統計データをPDF形式でダウンロード
- **優先度**: 高
- **実装状況**: 未実装
- **技術**: クライアントサイドでのPDF生成（jspdf + html2canvas または @react-pdf/renderer）

### レポート内容

#### サマリーセクション
- **説明**: 期間全体の概要
- **優先度**: 高
- **実装状況**: 未実装
- **内容**:
  - レポート対象期間
  - グループ名
  - 合計服用予定回数
  - 実際に服用した回数
  - スキップ回数
  - 未記録回数
  - 全体の服薬継続率（%）

#### 薬別統計セクション
- **説明**: 薬ごとの詳細統計
- **優先度**: 高
- **実装状況**: 未実装
- **内容**:
  - 薬名
  - 服用回数 / 予定回数
  - 服薬継続率（%）
  - 合計用量（単位付き）

#### タイミング別統計セクション
- **説明**: 時間帯ごとの服薬状況
- **優先度**: 中
- **実装状況**: 未実装
- **内容**:
  - 朝/昼/夕/就寝前ごとの服薬率
  - 頓服の実績（参考値）

#### 日別カレンダーセクション
- **説明**: 日ごとの服薬達成率をカレンダー形式で表示
- **優先度**: 低
- **実装状況**: 未実装
- **内容**:
  - 各日の服薬率を色分け表示
  - 100%: 緑、80-99%: 黄緑、50-79%: 黄、0-49%: 赤

---

## データモデル

この機能では新規テーブルは不要。既存の統計クエリ（`getMedicationStatsByPeriod`）のデータを使用。

### 使用する既存データ

```typescript
// getMedicationStatsByPeriod の戻り値
{
  medicines: Array<{
    medicineId?: Id<"medicines">,
    medicineName: string,
    totalAmount: number,
    unit: string,
    totalDoses: number,
    takenCount: number,
    skippedCount: number,
    pendingCount: number,
    adherenceRate: number,
  }>,
  summary: {
    totalMedicines: number,
    totalDoses: number,
    totalTaken: number,
    totalSkipped: number,
    totalPending: number,
    overallAdherenceRate: number,
  },
  period: {
    startDate: string,
    endDate: string,
    days: number,
  },
}
```

---

## ビジネスルール

### レポート生成

1. **期間制限**: 最大1年分のデータをレポート化可能
   - 例: 2025-01-01 〜 2026-01-01

2. **データがない場合**: 期間内に服薬記録がない場合は「記録なし」と表示
   - 例: 「この期間には服薬記録がありません」

3. **薬名グルーピング適用**: 薬名統合グループの設定がある場合は統合後のデータで出力
   - 例: 「ロキソニン錠」「ロキソニン60mg」→「ロキソニン」に統合

### レポートフォーマット

1. **用紙サイズ**: A4縦
2. **言語**: 日本語
3. **ファイル名**: `服薬レポート_[グループ名]_[開始日]_[終了日].pdf`
   - 例: `服薬レポート_田中家_2025-12-01_2025-12-31.pdf`

---

## 権限設計（RBAC）

### ロール定義

| ロール | 説明 | 主な権限 |
|--------|------|----------|
| patient | 患者ロール | 自グループのレポート出力 |
| supporter | 支援者ロール | 自グループのレポート出力 |

### 権限マトリクス

| 操作 | patient | supporter | 備考 |
|------|---------|-----------|------|
| レポート出力 | ✅ | ✅ | 自グループのみ |
| 期間選択 | ✅ | ✅ | |

---

## API設計

### Queries（データ取得）

この機能では新規APIは不要。既存の統計クエリを使用。

#### `medications.statistics.queries.getMedicationStatsByPeriod`
- **用途**: レポート用のデータ取得
- **認証**: 必須
- **引数**: `{ groupId, patientId?, startDate, endDate }`
- **戻り値**: 統計データ（上記参照）

### クライアントサイド処理

PDF生成はクライアントサイドで実行。サーバーサイドAPIは不要。

---

## UI/UX要件

### 画面構成

#### 統計画面（`/statistics`）の拡張
- **パス**: `/statistics`
- **変更点**: レポート出力ボタンを追加
- **主要コンポーネント**:
  - `PdfReportButton`: PDFダウンロードボタン
  - `PdfReportGenerator`: PDF生成ロジック

### UI配置

```
┌─────────────────────────────────────┐
│ 統計                                │
├─────────────────────────────────────┤
│ [期間選択: 過去30日間 ▼]            │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ サマリー                        │ │
│ │ 服薬継続率: 85%                 │ │
│ │ ...                             │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 薬別統計                        │ │
│ │ ...                             │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [📄 PDFをダウンロード]              │ ← 新規追加
│                                     │
└─────────────────────────────────────┘
```

### インタラクション

1. **PDFダウンロード**:
   - トリガー: 「PDFをダウンロード」ボタンクリック
   - フィードバック:
     - ローディング表示（生成中）
     - 完了時: ファイルダウンロード開始
     - エラー時: Toast通知でエラーメッセージ

---

## バリデーション

### フロントエンド

```typescript
// 期間バリデーション
const validatePeriod = (startDate: string, endDate: string) => {
  const start = new Date(startDate);
  const end = new Date(endDate);

  // 開始日 <= 終了日
  if (start > end) {
    return { valid: false, error: "開始日は終了日以前にしてください" };
  }

  // 最大1年
  const diffDays = (end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24);
  if (diffDays > 365) {
    return { valid: false, error: "期間は最大1年までです" };
  }

  return { valid: true };
};
```

---

## エラーハンドリング

| エラータイプ | メッセージ | 発生条件 | ユーザーアクション |
|--------------|-----------|----------|-------------------|
| データなし | "この期間には服薬記録がありません" | 期間内に記録がない | 期間を変更 |
| PDF生成エラー | "PDFの生成に失敗しました" | ライブラリエラー | 再試行 |
| 期間不正 | "開始日は終了日以前にしてください" | 開始日 > 終了日 | 日付を修正 |

---

## セキュリティ要件

### 認証
- Convex Auth: グループメンバーのみがレポート出力可能

### 認可
- 自分が所属するグループのデータのみ出力可能

### データ保護
- PDF生成はクライアントサイドで実行（サーバーにPDFデータを送信しない）
- 生成されたPDFはユーザーのローカルに保存

---

## パフォーマンス要件

- **PDF生成時間**: 3秒以内（30日分のデータ）
- **ファイルサイズ**: 1MB以下

### 最適化戦略
1. 必要最小限のデータのみ取得
2. 画像は使用せずテキストベースのレポート
3. 大量データの場合はページ分割

---

## テスト要件

### ユニットテスト
- [ ] 期間バリデーション
- [ ] ファイル名生成
- [ ] 統計データのフォーマット

### 統合テスト
- [ ] 統計データ取得→PDF生成フロー
- [ ] 空データでのPDF生成

### E2Eテスト
- [ ] 統計画面→期間選択→PDFダウンロード
- [ ] 異なる期間でのレポート生成

テスト実装: `app/_shared/features/pdf-report/__tests__/`

---

## 依存関係

### 内部依存
- 統計機能: `getMedicationStatsByPeriod` クエリ
- グループ機能: グループ情報の取得

### 外部依存
- **jspdf**: PDF生成ライブラリ（候補1）
- **@react-pdf/renderer**: React PDF生成ライブラリ（候補2）
- **html2canvas**: DOM→画像変換（jspdf使用時）

### 技術選定

| ライブラリ | メリット | デメリット |
|-----------|---------|-----------|
| jspdf + html2canvas | 既存UIをそのままPDF化 | 画像ベースで重くなる可能性 |
| @react-pdf/renderer | 軽量、テキストベース | 専用コンポーネントが必要 |

**推奨**: `@react-pdf/renderer`
- 理由: 軽量、テキストベースで編集可能なPDF、React親和性が高い

---

## マイルストーン

### Phase 1: MVP（未着手）
- [ ] ライブラリ選定・インストール
- [ ] PDFレポートコンポーネント作成
- [ ] サマリーセクション実装
- [ ] 薬別統計セクション実装
- [ ] ダウンロードボタン統合
- [ ] 基本的なスタイリング

### Phase 2: 機能拡張（未着手）
- [ ] タイミング別統計セクション
- [ ] 日別カレンダーセクション
- [ ] レポートのカスタマイズ（表示項目選択）

### Phase 3: 最適化（未着手）
- [ ] デザイン改善
- [ ] 印刷用スタイル最適化
- [ ] 多言語対応

---

## 既知の課題

| 課題 | 優先度 | 対応予定 | 備考 |
|------|--------|----------|------|
| 日本語フォント対応 | 高 | Phase 1 | @react-pdf/rendererで対応可能 |
| 大量データ時のパフォーマンス | 中 | Phase 2 | ページ分割で対応 |

---

## 関連ドキュメント

- [服薬管理機能仕様](medication.md)
- [プロジェクト概要](../../project.md)
- [アーキテクチャ](../../architecture.md)
- [競合調査レポート](../../reports/2026-01-11-competitor-analysis.md)
