# 服薬記録履歴閲覧機能仕様

**最終更新**: 2025年11月09日

## 概要

グループメンバーが過去の服薬記録を検索・閲覧できる機能を提供します。日付範囲、薬名、ステータス、タイミングなど柔軟なフィルター機能により、必要な記録を素早く見つけることができます。デフォルトで過去1週間の記録が表示されます。

---

## ユースケース

### 主要シナリオ

**シナリオ1: 最近の服薬記録を確認**
1. ダッシュボードから「記録履歴」ページに遷移
2. デフォルトで過去1週間の記録が自動的に表示される
3. 記録の編集・追加が可能

**シナリオ2: 特定期間の記録を確認**
1. 記録履歴ページで検索・フィルターセクションを開く
2. 日付範囲ピッカーから期間を選択
3. 選択した期間の全記録が一覧表示
4. 各日の記録を編集可能

**シナリオ3: 特定の薬の記録を検索**
1. 検索・フィルターセクションで薬名を入力
2. 必要に応じてステータスやタイミングでさらに絞り込み
3. フィルター条件に一致する記録が編集可能な形式で表示（当月全体から検索）

---

## 機能要件

### 初期表示

#### デフォルト表示
- **説明**: ページ読み込み時に過去1週間の記録を自動表示
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **表示範囲**: 今日から7日前まで
- **効果**: ユーザー操作なしで即座に最近の記録を確認可能

### 記録表示

#### 服薬記録詳細
- **説明**: 選択した日または日付範囲、フィルター条件に一致する服薬記録を表示
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **表示項目**:
  - タイミング（朝・昼・晩・就寝前・頓服）
  - ステータス（服用済み・スキップ・未服用）
  - 服薬時刻（takenAt）
  - メモ（notes）
  - 薬剤名、処方名、用量
  - 編集・操作ボタン（MedicationRecordActions）
- **機能**:
  - 日付範囲選択時は複数日の記録を縦に並べて表示
  - フィルター使用時は条件に一致する記録を日付降順で表示
  - 各記録は編集可能（MedicationRecordActionsを通じて）

### フィルター機能

#### 検索・フィルター
- **説明**: 日付範囲、薬名、ステータス、タイミング、並び替えで記録を検索・絞り込み
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **フィルター項目**:
  - **日付範囲選択**: Popoverカレンダーピッカーで範囲選択
    - 単一日付または日付範囲の選択が可能
    - デフォルトで過去1週間が選択された状態
    - 未来の日付は選択不可
    - クリアボタンで選択解除
  - **薬名検索**: 部分一致で検索
  - **ステータス**: 全て・服用済み・スキップ・未服用
  - **タイミング**: 全て・朝・昼・晩・就寝前・頓服
  - **並び替え**: 新しい順（降順）・古い順（昇順）
    - デフォルトで新しい順（降順）
- **動作**:
  - 日付範囲のみ指定時: 指定期間の全記録を選択された並び順で表示
  - 薬名・ステータス・タイミングいずれかを指定時: 当月の全記録から検索（日付範囲は無視）
  - 検索結果は選択された並び順で表示

#### 患者選択
- **説明**: サポーターが複数の患者から閲覧対象を選択
- **優先度**: 中
- **実装状況**: 未実装（将来対応予定）
- **権限**:
  - 服薬者: 自分の記録のみ表示（選択不要）
  - サポーター: グループ内の全患者から選択可能

---

## データモデル

### 使用する既存テーブル

#### `medicationRecords`（服薬記録）
既存のテーブルを参照。詳細は [medication.md](./medication.md) を参照。

**この機能で使用するフィールド**:
```typescript
{
  _id: Id<"medicationRecords">,
  groupId: Id<"groups">,
  patientId: string,
  timing: "morning" | "noon" | "evening" | "bedtime" | "asNeeded",
  scheduledDate: string,          // YYYY-MM-DD形式
  takenAt?: number,               // 服用時刻
  status: "pending" | "taken" | "skipped",
  recordedBy: string,
  notes?: string,
}
```

**使用するインデックス**:
- `by_groupId_scheduledDate`: 特定グループの特定月の記録取得
- `by_patientId_scheduledDate`: 特定患者の特定月の記録取得

---

## ビジネスルール

### 服用率の計算

1. **日別服用率**:
   ```typescript
   dailyRate = (takenCount / (takenCount + skippedCount)) * 100
   ```
   - `pending`ステータスは計算から除外
   - 記録が存在しない日は「記録なし」として表示

2. **月別服用率**:
   ```typescript
   monthlyRate = (totalTaken / (totalTaken + totalSkipped)) * 100
   ```

3. **色分けルール**:
   - 100%: 緑（全てのタイミングで服用）
   - 1-99%: 黄（一部のタイミングで服用）
   - 0%: 赤（全てスキップ）
   - 記録なし: グレー

### 表示範囲の制限

1. **過去の記録**: 制限なし（全期間表示可能）
2. **未来の記録**: 表示しない（今日まで）

---

## 権限設計（RBAC）

### ロール定義

| ロール | 説明 | 主な権限 |
|--------|------|----------|
| patient | 服薬者 | 自分の記録のみ閲覧 |
| supporter | サポーター | グループ内全患者の記録を閲覧 |

### 権限マトリクス

| 操作 | patient | supporter | 備考 |
|------|---------|-----------|------|
| 自分の記録閲覧 | ✅ | ✅ | |
| 他の患者の記録閲覧 | ❌ | ✅ | 同一グループ内のみ |
| 統計情報表示 | ✅ | ✅ | 閲覧権限がある記録のみ |

---

## API設計

### Queries（データ取得）

#### `medications.getMonthlyRecords`（新規作成）
- **用途**: 指定月の服薬記録を全て取得
- **認証**: 必須
- **引数**:
  ```typescript
  {
    groupId: Id<"groups">,
    patientId?: string,  // 未指定時は自分の記録
    year: number,        // 例: 2025
    month: number,       // 1-12
  }
  ```
- **戻り値**:
  ```typescript
  Array<{
    _id: Id<"medicationRecords">,
    timing: Timing,
    scheduledDate: string,
    status: "pending" | "taken" | "skipped",
    takenAt?: number,
    notes?: string,
    recordedBy: string,
    medicineName?: string,
  }>
  ```

#### `medications.getMonthlyStats`（新規作成）
- **用途**: 指定月の統計情報を取得
- **認証**: 必須
- **引数**:
  ```typescript
  {
    groupId: Id<"groups">,
    patientId?: string,
    year: number,
    month: number,
  }
  ```
- **戻り値**:
  ```typescript
  {
    totalScheduled: number,
    totalTaken: number,
    totalSkipped: number,
    totalPending: number,
    adherenceRate: number,  // 0-100
    dailyStats: Record<string, {  // キー: YYYY-MM-DD
      taken: number,
      skipped: number,
      pending: number,
      rate: number,  // 0-100
    }>,
    timingStats: {
      morning: { taken: number, skipped: number, rate: number },
      noon: { taken: number, skipped: number, rate: number },
      evening: { taken: number, skipped: number, rate: number },
      bedtime: { taken: number, skipped: number, rate: number },
      asNeeded: { taken: number, skipped: number, rate: number },
    }
  }
  ```

#### 既存API: `medications.getTodayRecords`
特定日の詳細表示に使用（既に実装済み）

---

## UI/UX要件

### 画面構成

#### 記録履歴ページ
- **パス**: `/history`
- **目的**: 過去の服薬記録を検索・閲覧
- **レイアウト**: 1カラム垂直レイアウト
- **主要コンポーネント**:
  - `RecordFilters`: 検索・フィルターUI
    - 日付範囲ピッカー（Popover + Calendar）
    - 薬名検索
    - ステータス・タイミング選択
  - `RecordDetailView`: 記録詳細表示
    - `DayRecordSection`: 単一日の記録セクション（内部コンポーネント）
    - `FilteredRecordsView`: フィルター結果ビュー（内部コンポーネント）
- **削除されたコンポーネント**:
  - `CalendarView`: フィルター内の日付範囲ピッカーに統合
  - `DailyRecordDetail`: RecordDetailViewに統合
  - `FilteredRecordsList`: RecordDetailViewに統合
  - `HistoryHeader`: 簡素化のため削除（h1タグで代替）
  - `PatientSelector`: 未実装（将来対応予定）
  - `MonthlyStatsCard`: 未実装（将来対応予定）

### インタラクション

1. **日付範囲選択**:
   - トリガー: フィルターの日付範囲ピッカーから選択
   - フィードバック: 下部の記録詳細セクションに選択期間の記録が表示
   - 動作: 薬名・ステータス・タイミングフィルターが未使用の場合のみ有効
   - 制約: 未来の日付は選択不可
   - デフォルト: 過去1週間が自動選択

2. **フィルター適用**:
   - トリガー: 日付範囲選択、薬名入力、ステータス選択、タイミング選択
   - フィードバック: 条件に一致する記録が記録詳細セクションに表示
   - 動作: 薬名・ステータス・タイミングのいずれかが設定されている場合、日付範囲選択は無効化され、当月全体から検索

3. **記録の編集**:
   - トリガー: 記録詳細内の操作ボタン（服用/スキップ/削除など）
   - フィードバック: MedicationRecordActionsコンポーネントによる即座の状態変更
   - 制約: 今日または過去の日付のみ編集可能

4. **患者選択**:
   - 実装状況: 未実装（将来対応予定）
   - トリガー: ドロップダウンから患者を選択
   - フィードバック: 選択した患者の記録に表示が更新

---

## バリデーション

### フロントエンド

- 未来の日付は選択不可（今日まで）

### バックエンド

```typescript
// グループメンバーシップの確認
const membership = await ctx.db
  .query("groupMembers")
  .withIndex("by_userId", (q) => q.eq("userId", userId))
  .filter((q) => q.eq(q.field("groupId"), args.groupId))
  .first();

if (!membership) {
  throw new Error("このグループのメンバーではありません");
}

// サポーターでない場合は自分の記録のみ
if (membership.role !== "supporter" && args.patientId && args.patientId !== userId) {
  throw new Error("他のユーザーの記録を閲覧する権限がありません");
}
```

---

## エラーハンドリング

| エラータイプ | メッセージ | 発生条件 | ユーザーアクション |
|--------------|-----------|----------|-------------------|
| 認証エラー | "認証が必要です" | 未認証状態でアクセス | ログインページへ遷移 |
| 権限エラー | "他のユーザーの記録を閲覧する権限がありません" | 服薬者が他人の記録を要求 | 自分の記録のみ表示 |
| グループエラー | "このグループのメンバーではありません" | 非メンバーがアクセス | ダッシュボードへ遷移 |

---

## セキュリティ要件

### 認証
- Convex Auth による認証必須

### 認可
- グループメンバーシップの確認
- ロールベースのアクセス制御（patient/supporter）
- 服薬者は自分の記録のみアクセス可能

### データ保護
- 患者の服薬記録は機密情報として扱う
- グループ外のユーザーからアクセス不可

---

## パフォーマンス要件

- **レスポンスタイム**: < 500ms（月別データ取得）
- **データ量**: 1ヶ月あたり最大 120件（4タイミング × 30日）
- **キャッシュ戦略**: Convexのリアクティブクエリによる自動最適化

### 最適化戦略
1. インデックスを活用した効率的なクエリ（`by_groupId_scheduledDate`）
2. 必要なフィールドのみ取得
3. 統計計算はバックエンドで実行

---

## テスト要件

### ユニットテスト
- [ ] 服用率計算ロジック
- [ ] 日別統計計算ロジック
- [ ] 色分けロジック

### 統合テスト
- [ ] 月別記録取得API
- [ ] 統計情報取得API
- [ ] 権限チェック（patient/supporter）

### E2Eテスト
- [ ] カレンダー表示と月の切り替え
- [ ] 日付クリックで詳細表示
- [ ] 患者選択による表示切り替え（サポーター）

---

## 依存関係

### 内部依存
- [グループ管理](./group.md): グループメンバーシップ確認
- [服薬管理](./medication.md): 服薬記録データ
- [認証](./auth.md): ユーザー認証

### 外部依存
- **shadcn/ui Calendar** (@radix-ui/react-popover + react-day-picker): 日付範囲ピッカー
- **date-fns**: 日付操作（`subDays`, `format`など）
- **date-fns-tz**: タイムゾーン処理（JST）

---

## マイルストーン

### Phase 1: MVP（完了）
- [x] バックエンドAPI実装（`getMonthlyRecords`）
- [x] カレンダーライブラリの選定とインストール（shadcn/ui Calendar使用）
- [x] `RecordDetailView`コンポーネント実装（日付範囲選択とフィルター結果を統合）
- [x] `RecordFilters`コンポーネント実装（日付範囲ピッカー、薬名検索、ステータス・タイミングフィルター）
- [x] 記録履歴ページ実装（1カラム垂直レイアウト）
- [x] ダッシュボードからのナビゲーション追加
- [x] デフォルトで過去1週間を選択する初期表示
- [ ] `MonthlyStatsCard`コンポーネント実装（保留）

### Phase 2: 機能拡張（未着手）
- [ ] 月別統計カード実装（服薬継続率、タイミング別服用率など）
- [ ] 統計グラフ表示（折れ線グラフ、円グラフ）
- [ ] データエクスポート機能（CSV/PDF）
- [ ] 複数月にわたる検索機能

### Phase 3: 最適化（未着手）
- [ ] ページネーション
- [ ] 仮想スクロール
- [ ] データキャッシュ最適化

---

## 既知の課題

| 課題 | 優先度 | 対応予定 | 備考 |
|------|--------|----------|------|
| ~~カレンダーライブラリの選定~~ | ~~高~~ | ~~Phase 1~~ | ✅ 解決: shadcn/ui Calendarを採用 |
| ~~フィルター使用時のカレンダー連動~~ | ~~中~~ | ~~Phase 1~~ | ✅ 解決: カレンダービューを削除し、フィルター内の日付範囲ピッカーに一本化 |
| ~~統計表示の視覚的フィードバック~~ | ~~中~~ | ~~Phase 1~~ | ✅ 解決: カレンダー表示を削除し、シンプルな検索・フィルターUIに集約 |
| 月別統計カードの実装 | 中 | Phase 2 | APIは準備済み、UI実装が保留 |

---

## 関連ドキュメント

- [服薬管理機能](./medication.md)
- [グループ管理機能](./group.md)
- [認証機能](./auth.md)
- [プロジェクト概要](../../project.md)
- [アーキテクチャ](../../architecture.md)
