# 服薬メモ機能仕様

**最終更新**: 2025年11月30日

## 概要

服薬記録に対してメモを残せる機能を提供します。副作用の記録、服用時の感想、診察時に医師へ伝えたいことなど、汎用的なメモとして活用できます。履歴画面と連携し、メモ付きの記録をフィルターして一覧表示したり、診察用にエクスポートすることもできます。

---

## ユースケース

### 主要シナリオ

**シナリオ1: 服薬時にメモを記録**
1. 服薬記録画面で薬を「服用済み」にする
2. 「メモを追加」ボタンをタップ
3. 「この薬は少し眠気が出る」などの感想を入力
4. 保存して記録完了

**シナリオ2: メモ付き記録を一覧表示**
1. 履歴画面で「メモ付きのみ」フィルターを有効化
2. メモが記録された服薬記録のみが一覧表示される
3. 各記録のメモ内容を確認

**シナリオ3: 診察用にメモをエクスポート**
1. 履歴画面でフィルター（日付範囲、メモ付きのみ）を設定
2. 「メモをエクスポート」ボタンをタップ
3. テキスト形式でメモ一覧がコピーされる
4. 診察時に医師へ見せる/共有する

---

## 機能要件

### メモの作成・編集

#### メモ追加機能
- **説明**: 服薬記録に対してメモを追加する
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **文字数制限**: 500文字
- **入力方法**: テキストエリアによる自由入力

#### メモ編集機能
- **説明**: 既存のメモを編集・更新する
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **動作**: メモをタップすると編集ダイアログが開く

#### メモ削除機能
- **説明**: メモを削除（空文字に更新）する
- **優先度**: 中
- **実装状況**: ✅ 実装済み

### メモ一覧・フィルター

#### メモ付き記録フィルター
- **説明**: メモが記録されている服薬記録のみを表示
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **場所**: 履歴画面のフィルターセクション

#### メモ一覧表示
- **説明**: フィルター適用後のメモ付き記録を一覧表示
- **優先度**: 高
- **実装状況**: ✅ 実装済み
- **表示項目**: 日付、タイミング、薬名、メモ内容

### エクスポート機能

#### メモエクスポート
- **説明**: フィルター適用後のメモ一覧をテキスト形式でエクスポート
- **優先度**: 中
- **実装状況**: ✅ 実装済み
- **形式**: プレーンテキスト（クリップボードコピー）
- **内容例**:
  ```
  === 服薬メモ一覧 ===
  期間: 2025/11/01 - 2025/11/30

  [2025/11/25 朝] ロキソニン
  頭痛がひどかったので服用。30分後に改善。

  [2025/11/20 夕] アムロジピン
  少しめまいがした。次回診察で相談する。
  ```

---

## データモデル

### 使用する既存テーブル

#### `medicationRecords`（服薬記録）
既存のテーブルを使用。新規フィールド追加は不要。

**この機能で使用するフィールド**:
```typescript
{
  _id: Id<"medicationRecords">,
  notes?: string,           // メモ内容（500文字以内）
  updatedAt: number,        // メモ更新日時としても使用
  // ... 他のフィールド
}
```

---

## ビジネスルール

### メモの文字数制限

1. **最大文字数**: 500文字
   - 理由: 診察時に医師へ簡潔に伝えるため
   - 超過時: フロントエンドでバリデーションエラー

### メモの表示ルール

1. **空のメモ**: 非表示（メモなしとして扱う）
2. **改行**: 維持して表示
3. **長いメモ**: 一覧では3行で省略、タップで全文表示

---

## 権限設計（RBAC）

### 権限マトリクス

| 操作 | patient | supporter | 備考 |
|------|---------|-----------|------|
| 自分のメモ追加 | ✅ | ✅ | |
| 自分のメモ編集 | ✅ | ✅ | |
| 他人のメモ閲覧 | ❌ | ✅ | サポーターは患者のメモを閲覧可能 |
| 他人のメモ編集 | ❌ | ✅ | サポーターは患者のメモを編集可能 |

---

## API設計

### 既存API（変更不要）

#### `medications.records.updateMedicationRecord`
- **用途**: メモの追加・編集・削除
- **認証**: 必須
- **引数**:
  ```typescript
  {
    recordId: Id<"medicationRecords">,
    notes?: string,  // メモ内容（空文字で削除）
  }
  ```
- **戻り値**: `Result<Record<string, never>>`

### 新規Query

#### `medications.records.getRecordsWithMemo`
- **用途**: メモ付きの服薬記録を取得
- **認証**: 必須
- **引数**:
  ```typescript
  {
    groupId: Id<"groups">,
    startDate: string,    // YYYY-MM-DD
    endDate: string,      // YYYY-MM-DD
    medicineId?: Id<"medicines">,  // 薬剤フィルター（任意）
    timing?: Timing,               // タイミングフィルター（任意）
  }
  ```
- **戻り値**:
  ```typescript
  Array<{
    _id: Id<"medicationRecords">,
    scheduledDate: string,
    timing: Timing,
    medicineName?: string,
    notes: string,
    updatedAt: number,
  }>
  ```

---

## UI/UX要件

### コンポーネント構成

#### メモ追加ボタン（MedicationRecordActionsに追加）
- **場所**: 服薬記録の各アイテムのアクション部分
- **アイコン**: MessageSquare（メモアイコン）
- **動作**: タップでメモ編集ダイアログを開く

#### メモ編集ダイアログ（MemoEditDialog）
- **トリガー**: メモ追加ボタンまたは既存メモタップ
- **内容**:
  - テキストエリア（500文字制限）
  - 残り文字数表示
  - 保存/キャンセルボタン
- **バリデーション**: リアルタイムで文字数チェック

#### メモ付きフィルター（RecordFiltersに追加）
- **場所**: 履歴画面のフィルターセクション
- **UI**: チェックボックス「メモ付きのみ」
- **動作**: 有効時はメモがある記録のみ表示

#### メモエクスポートボタン
- **場所**: 履歴画面のフィルターセクション下部
- **条件**: メモ付きフィルターが有効な時のみ表示
- **動作**: フィルター結果のメモ一覧をクリップボードにコピー

### 視覚的識別

#### メモ付き記録のバッジ
- **場所**: 服薬記録アイテム
- **表示**: MessageSquareアイコン + 「メモ」バッジ
- **色**: 黄色系（情報を示す）

---

## バリデーション

### フロントエンド

```typescript
const memoSchema = z.object({
  notes: z.string()
    .max(500, "メモは500文字以内で入力してください")
    .optional(),
});
```

### バックエンド

既存の `updateMedicationRecord` mutation でバリデーション済み。
文字数制限は フロントエンドで制御。

---

## エラーハンドリング

| エラータイプ | メッセージ | 発生条件 | ユーザーアクション |
|--------------|-----------|----------|-------------------|
| 認証エラー | "認証が必要です" | 未認証状態 | ログインページへ遷移 |
| 権限エラー | "このグループのメンバーではありません" | 非メンバー | ダッシュボードへ遷移 |
| バリデーションエラー | "メモは500文字以内で入力してください" | 文字数超過 | 入力内容を修正 |

---

## セキュリティ要件

### 認証
- Convex Auth による認証必須

### 認可
- グループメンバーシップの確認
- ロールベースのアクセス制御（patient/supporter）

### データ保護
- メモ内容はグループ外のユーザーからアクセス不可
- XSS対策: メモ内容はエスケープして表示

---

## パフォーマンス要件

- **レスポンスタイム**: < 300ms（メモ更新）
- **データ量**: 期間あたり最大数百件のメモ
- **最適化**: インデックスを活用した効率的なクエリ

---

## テスト要件

### ユニットテスト
- [ ] メモ文字数バリデーション
- [ ] エクスポートテキスト生成ロジック

### 統合テスト
- [ ] メモ付き記録取得API
- [ ] メモ更新API（追加・編集・削除）

### E2Eテスト
- [ ] メモ追加フロー
- [ ] メモ編集フロー
- [ ] メモ付きフィルター
- [ ] メモエクスポート

---

## 依存関係

### 内部依存
- [服薬管理機能](./medication.md): 服薬記録データ
- [履歴閲覧機能](./medication-history.md): フィルター機能との連携
- [認証機能](./auth.md): ユーザー認証

### 外部依存
- **shadcn/ui Dialog**: メモ編集ダイアログ
- **shadcn/ui Textarea**: メモ入力
- **lucide-react**: アイコン（MessageSquare）

---

## マイルストーン

### Phase 1: MVP（完了）
- [x] 既存APIの確認（notes フィールド対応済み）
- [x] メモ編集ダイアログコンポーネント作成
- [x] MedicationRecordActions にメモ追加ボタン追加
- [x] 履歴画面でメモ付きバッジ表示
- [x] テスト作成（MemoEditDialog）

### Phase 2: フィルター・一覧（完了）
- [x] RecordFilters に「メモ付きのみ」チェックボックス追加
- [x] メモ一覧の視覚的改善

### Phase 3: エクスポート（完了）
- [x] エクスポートテキスト生成ロジック
- [x] エクスポートボタンUI
- [x] クリップボードコピー機能

---

## 既知の課題

| 課題 | 優先度 | 対応予定 | 備考 |
|------|--------|----------|------|
| メモの検索機能 | 低 | 将来検討 | キーワード検索の需要を確認後 |
| メモのタグ付け | 低 | 将来検討 | 「副作用」「質問」などのタグ |
| 音声入力対応 | 低 | 将来検討 | アクセシビリティ向上 |

---

## 関連ドキュメント

- [服薬管理機能](./medication.md)
- [履歴閲覧機能](./medication-history.md)
- [プロジェクト概要](../../project.md)
- [アーキテクチャ](../../architecture.md)
