# 過去の服薬記録編集・作成機能仕様

**最終更新**: 2025年10月26日

## 概要

過去の日付の服薬記録を編集・作成できる機能を提供します。誤った記録の修正や、記録の付け忘れに対応するため、履歴ページから過去の日付を選択して記録を編集・作成できるようにします。

---

## 背景・課題

### 現在の状況

- **ダッシュボード**: 当日の服薬記録のみ作成・編集可能
- **履歴ページ**: 過去の記録を閲覧のみ（編集・作成機能なし）

### 課題

1. **誤記録の修正不可**: 記録後に誤りに気づいても、翌日以降は修正できない
2. **記録の付け忘れ**: 記録を付け忘れた場合、後から追加できない
3. **ユーザビリティ**: 過去の記録を確認しながら編集できない

---

## ユースケース

### 主要シナリオ

**シナリオ1: 誤った記録を翌日に修正**
1. ユーザーが履歴ページに遷移
2. カレンダーから前日を選択
3. 誤って「スキップ」とマークした記録を「服用済み」に変更
4. メモを追加して保存

**シナリオ2: 記録の付け忘れを後から追加**
1. ユーザーが履歴ページに遷移
2. カレンダーから記録がない過去の日付を選択
3. その日に有効だった薬剤が表示される
4. 記憶を頼りに記録を追加

**シナリオ3: 複数日分の記録を一括で修正**
1. ユーザーが履歴ページに遷移
2. 複数の日付を順番に選択しながら記録を修正
3. カレンダーの色が更新される

---

## 機能要件

### 1. 過去の日付の記録編集

#### 履歴ページの日別詳細セクションを拡張
- **説明**: カレンダーから選択した日付の記録を編集可能にする
- **優先度**: 高
- **実装状況**: 未実装

**表示内容**:
- 選択した日付に有効な処方箋の薬剤を表示
- 既存の記録がある場合は現在の状態を表示
- 記録がない場合は新規作成用のUIを表示

**操作**:
- 服用済み/スキップの切り替え
- メモの追加・編集
- 記録の削除

### 2. 過去の日付の新規記録作成

#### 記録がない日付への記録追加
- **説明**: その日に有効だった薬剤に対して記録を作成
- **優先度**: 高
- **実装状況**: 未実装

**バリデーション**:
- 未来の日付には記録を作成できない（今日まで）
- その日に有効な処方箋がない場合は、簡易記録のみ可能

### 3. UI改善

#### 編集モードと閲覧モードの切り替え
- **説明**: 過去の記録を誤って変更しないよう、明確なUI状態管理
- **優先度**: 中
- **実装状況**: 未実装

**デザイン方針**:
- ダッシュボードと同様の記録UIを使用
- 日付選択状態を明確に表示
- 変更があった場合は保存確認

---

## データモデル

### 既存テーブルを使用

#### `medicationRecords`
既存のテーブルをそのまま使用。日付制限は設けない。

**関連フィールド**:
```typescript
{
  scheduledDate: string,  // YYYY-MM-DD（過去の日付も許可）
  updatedAt: number,      // 最終更新日時
}
```

---

## API設計

### 既存APIを使用

#### 記録作成: `medicationRecords.mutations.recordSimpleMedication`
- 過去の日付での作成を許可（現在も日付制限なし）

#### 記録更新: `medicationRecords.mutations.updateMedicationRecord`
- 過去の記録の更新を許可（現在も日付制限なし）

#### 日付指定での薬剤取得: `prescriptions.queries.getActiveMedicationsForDateQuery`
- 過去の日付でも有効な薬剤を取得可能（既に実装済み）

### 新規API（必要に応じて）

なし。既存APIで十分対応可能。

---

## UI/UX要件

### 画面構成

#### 履歴ページ（`/history`）

**変更点**:
- `DailyRecordDetail` コンポーネントを拡張
- 閲覧のみ → 編集・作成可能に変更

**主要コンポーネント**:
1. **CalendarView**: 日付選択（既存）
2. **DailyRecordDetail**: 記録の閲覧・編集・作成（拡張）
   - 選択した日付に有効な薬剤リストを表示
   - `MedicationRecordActions` コンポーネントを使用
   - 既存記録の編集
   - 新規記録の作成

### インタラクション

#### 日付選択時
1. カレンダーから日付をクリック
2. その日に有効な薬剤を取得
3. 既存の記録と共に編集可能なUIを表示

#### 記録の編集
1. 記録のステータスを変更（服用済み/スキップ）
2. メモを追加・編集
3. 自動保存（または明示的な保存ボタン）

#### 新規記録の作成
1. 記録がない薬剤に対して「服用済み」または「スキップ」を選択
2. 必要に応じてメモを追加
3. 記録を保存

---

## ビジネスルール

### 日付制限

1. **過去の記録**: 制限なし（いつでも編集・作成可能）
2. **未来の記録**: 作成不可（今日まで）

### 有効な薬剤の判定

選択した日付に対して:
```typescript
// その日に有効な処方箋を取得
startDate <= selectedDate && (endDate === undefined || endDate >= selectedDate)
```

### 履歴保存

- 既存の記録を更新する場合は、`medicationRecordsHistory` に自動保存（既存の仕組み）
- 新規作成の場合は履歴なし

---

## セキュリティ要件

### 認証・認可

- グループメンバーのみがアクセス可能（既存の仕組みを踏襲）
- 服薬者は自分の記録のみ編集可能
- サポーターは全患者の記録を編集可能

---

## パフォーマンス要件

- **レスポンスタイム**: < 500ms（日付選択時のデータ取得）
- **キャッシュ戦略**: Convexのリアクティブクエリによる自動最適化

---

## エラーハンドリング

| エラータイプ | メッセージ | 発生条件 | ユーザーアクション |
|--------------|-----------|----------|-------------------|
| 未来の日付 | "未来の日付には記録を作成できません" | 今日より後の日付を選択 | 今日以前の日付を選択 |
| 権限エラー | "他のユーザーの記録を編集する権限がありません" | 服薬者が他人の記録を編集 | 自分の記録のみ編集 |

---

## 実装タスク

### Phase 1: コア機能（MVP） - ✅ 完了
- [x] `DailyRecordDetail` コンポーネントの拡張
  - [x] 選択した日付に有効な薬剤を取得
  - [x] `MedicationRecordActions` コンポーネントを統合
  - [x] 既存記録の編集UIを追加
  - [x] 新規記録作成UIを追加
- [x] 日付バリデーション（未来の日付を禁止）※既存のAPIで対応済み
- [x] この仕様書の作成

**実装完了日**: 2025年10月26日

**実装内容**:
- 履歴ページの `DailyRecordDetail` コンポーネントを拡張
- 選択した日付に有効な薬剤を `getActiveMedicationsForDateQuery` APIで取得
- 既存の `MedicationRecordActions` コンポーネントを再利用して編集・作成機能を実装
- 過去の日付の記録も作成・編集可能に（APIに日付制限がないため）

### Phase 2: UX改善
- [ ] 編集モードの視覚的フィードバック
- [ ] 保存確認ダイアログ
- [ ] エラー表示の改善

### Phase 3: 最適化
- [ ] パフォーマンス最適化
- [ ] E2Eテスト追加

---

## テスト要件

### ユニットテスト
- [ ] 日付バリデーション
- [ ] 有効な薬剤の判定ロジック

### 統合テスト
- [ ] 過去の日付での記録作成
- [ ] 過去の日付での記録更新
- [ ] 権限チェック

### E2Eテスト
- [ ] カレンダーから過去の日付を選択
- [ ] 記録を編集して保存
- [ ] 新規記録を作成
- [ ] カレンダーの色が正しく更新される

---

## 依存関係

### 内部依存
- [服薬記録履歴閲覧機能](./medication-history.md): 既存の履歴ページを拡張
- [服薬管理機能](./medication.md): 既存のAPIを使用

### 外部依存
なし（既存のライブラリで対応可能）

---

## 既知の課題

| 課題 | 優先度 | 対応予定 | 備考 |
|------|--------|----------|------|
| 大量の過去データ編集時のパフォーマンス | 低 | Phase 3 | 通常使用では問題なし |

---

## 関連ドキュメント

- [服薬記録履歴閲覧機能](./medication-history.md)
- [服薬管理機能](./medication.md)
- [アーキテクチャ](../../architecture.md)
