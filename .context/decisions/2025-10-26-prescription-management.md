# ADR: 処方箋管理機能の導入

**日付**: 2025年10月26日
**ステータス**: 承認済み
**決定者**: 開発者

---

## 背景

服薬記録履歴の統計機能を実装する過程で、以下の課題が明らかになった：

1. **未記録日の扱い**: レコードが全くない日をどう扱うかが不明確
2. **期待値の計算**: 「その日に服用すべきだった薬」を正確に把握できない
3. **薬の変更への対応**: 月の途中で薬が追加・削除された場合、統計が不正確になる

### 現在の実装の問題点

```typescript
// 現在：isActiveな薬のタイミング数 × 月の全日数
期待値 = 現在アクティブな薬のタイミング数 × 月の日数
```

この方法では：
- 10月1日に薬を追加 → 10月全体（31日分）の期待値に含まれてしまう
- 10月15日に薬を削除 → 10月1-14日の期待値から除外されてしまう
- 過去の統計が薬の現在の状態に依存してしまう

---

## 決定

### 処方箋管理機能を導入し、薬の有効期間を明示的に管理する

処方箋（prescription）を新しいエンティティとして追加し、薬と期間を紐付ける。

---

## 理由

### 1. ドメインモデルとして自然

実際の服薬管理のフローに即している：

```
医師が処方箋を発行（開始日・終了日あり）
  ↓
患者が処方箋に基づいて薬を登録
  ↓
期間内でスケジュール通りに服薬記録
  ↓
統計を見る（処方箋の期間に基づく正確な計算）
```

### 2. 統計計算のロジックが明確

```typescript
// 処方箋ベース（明確）
期待値 = その日に有効な処方箋に含まれる薬のタイミング数

// 具体例：
// 10/1-10/14: 処方箋A（薬3種、1日4回） → 期待値 12回/日
// 10/15-10/31: 処方箋B（薬2種、1日3回） → 期待値 6回/日
```

### 3. データの整合性

- 過去の統計は常に正確（処方箋データが残っている限り）
- 薬の追加・削除が統計に正しく反映される
- 将来の予定（例：1週間後から新しい薬）を事前登録できる

### 4. 将来の拡張性

処方箋情報を持つことで、以下の機能が実装しやすくなる：
- 処方箋の画像管理
- 薬局・医療機関との連携
- 薬の在庫管理（処方箋の期間から計算）
- 処方箋の更新通知

---

## 利点

✅ **正確な統計**: 期間ごとの期待値を正確に計算できる
✅ **自然なフロー**: 実際の服薬管理の流れに即している
✅ **データの整合性**: 過去の統計が薬の現在の状態に影響されない
✅ **拡張性**: 処方箋に関連する追加機能を実装しやすい
✅ **ユーザー理解**: 処方箋という概念は医療ドメインで一般的

---

## 欠点

❌ **初期実装コスト**: スキーマ追加、UI実装、既存コードの修正が必要
  → **対応**: 段階的に実装（最小限のスキーマから開始）

❌ **UXの複雑化**: ユーザーが処方箋と薬の関係を理解する必要がある
  → **対応**: わかりやすいUI/UXデザイン、適切なオンボーディング

❌ **既存データの移行**: 開発段階だが、テストデータの再作成が必要
  → **対応**: 現在は開発段階なので影響は最小限

---

## 代替案

### 1. 自動的な期間管理（inactivatedAtの追加）

```typescript
medicines: {
  createdAt: v.number(),
  inactivatedAt: v.optional(v.number()),
}
```

**メリット**:
- 実装が簡単
- UIの変更が最小限

**デメリット**:
- 薬単位の管理で、処方箋という概念がない
- 将来の予定（事前登録）ができない
- ドメインモデルとして不自然

**却下理由**: 処方箋機能は今後予定されており、今実装する方が自然

### 2. レコードベースの期待値計算

実際にレコードが存在する日のみを基準に統計を計算。

**メリット**:
- 実装が非常にシンプル

**デメリット**:
- レコードが全くない日は計算できない
- 「服薬すべきだった日」という概念が失われる
- 服用率の意味が曖昧になる

**却下理由**: 服薬管理アプリとして本質的な機能を失う

---

## 実装計画

### フェーズ1: 最小限のスキーマ実装 ✅

```typescript
prescriptions: defineTable({
  groupId: v.id("groups"),
  name: v.string(),                    // 処方箋名（例：「10月分の処方箋」）
  startDate: v.string(),               // YYYY-MM-DD
  endDate: v.optional(v.string()),     // YYYY-MM-DD（未指定 = 継続中）
  notes: v.optional(v.string()),
  createdBy: v.string(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
.index("by_groupId", ["groupId"])
.index("by_groupId_startDate", ["groupId", "startDate"]);
```

### フェーズ2: 薬との紐付け

```typescript
medicines: {
  prescriptionId: v.id("prescriptions"),
  // ... 既存フィールド
}
```

### フェーズ3: 統計計算ロジックの変更

`getMonthlyStats` を処方箋ベースの計算に変更：
- その月の各日付について、有効な処方箋を取得
- 処方箋に含まれる薬のタイミング数を集計
- 日別・月別の期待値を計算

### フェーズ4: UI実装

- 処方箋登録ページ
- 処方箋一覧ページ
- 薬登録時の処方箋選択
- 既存の薬追加UIの修正

### フェーズ5: 既存データの移行（開発段階）

- テストデータの再作成
- デフォルト処方箋の自動生成（オプション）

---

## 技術的考慮事項

### 1. 期間の重複

同じグループで複数の処方箋が同時に有効な場合：
- **許可する**: 複数の処方箋を並行して管理できる（柔軟性）
- **禁止する**: 期間の重複チェックを実装（シンプル）

→ **決定**: 初期は許可する（柔軟性を優先）

### 2. 処方箋なしの薬

移行期間中、処方箋に紐付かない薬が存在する可能性：
- **対応**: `prescriptionId` を optional にする
- 処方箋なしの薬は「デフォルト処方箋」として扱う

### 3. 統計計算のパフォーマンス

処方箋データが増えると、統計計算が複雑になる：
- **対応**:
  - インデックスの最適化（by_groupId_startDate）
  - 必要に応じてキャッシュを導入

---

## 関連ドキュメント

- [プロジェクト概要](../project.md)
- [アーキテクチャ](../architecture.md)
- [服薬記録機能仕様](../specs/features/medication.md)
- [服薬記録履歴機能仕様](../specs/features/medication-history.md)

---

## 承認

| 役割 | 名前 | 日付 |
|------|------|------|
| 提案者 | AI | 2025-10-26 |
| レビュー | 開発者 | 2025-10-26 |
| 承認者 | 開発者 | 2025-10-26 |

---

## 次のステップ

1. ✅ ADR作成（このドキュメント）
2. ⏳ ユーザーによるレビューと承認
3. ⏳ 処方箋スキーマの実装
4. ⏳ 統計計算ロジックの変更
5. ⏳ UI実装
6. ⏳ テストデータの再作成
