# 決定記録: プッシュ通知機能の実装

**日付**: 2025年11月20日
**ステータス**: 承認済み
**決定者**: 開発者

---

## 背景

お薬管理アプリにおいて、服薬リマインダーは**服薬アドヒアランス向上**のために不可欠な機能である。ユーザーから以下の要望が明確化された：

### 現状の問題点

#### 1. 服薬忘れのリスク

現在の実装では以下の問題がある：
- 服薬時刻になっても通知されない
- ユーザーが能動的にアプリを開かないと記録できない
- 服薬忘れが発生しやすい

#### 2. アドヒアランス向上の必要性

本アプリのミッションは「服薬アドヒアランス向上」であり：
- リマインダーなしでは目的を達成できない
- 患者と支援者の両方から通知機能の要望が高い
- 継続的な服薬管理には通知が必須

#### 3. iOS対応の課題

プッシュ通知実装において、iOS Safariが最大の課題：
- iOS 16.4+でWeb Push APIをサポート（2023年3月〜）
- ただし**PWAとしてホーム画面に追加**していることが必須条件
- ブラウザで開いているだけでは通知を受け取れない

### なぜ今決定する必要があるのか

- プロジェクトの基盤（認証、データベース、UI）が整った
- 次のマイルストーンとして通知機能が適切
- iOS対応の技術選定を早期に決定し、段階的に実装したい

---

## 決定

### PWA + Web Push APIによるプッシュ通知機能を実装する

以下の方針で段階的に導入する：

#### Phase 1: PWA基礎（1-2時間）
- `manifest.json`の作成（アプリ名、アイコン、テーマカラー）
- 基本的なService Workerの設定
- インストール可能なPWAにする
- `display: standalone`の設定（iOS Web Push必須要件）

#### Phase 2: プッシュ通知基盤（2-3時間）
- VAPID鍵ペアの生成・環境変数設定
- Web Push APIの統合
- 通知許可UIの実装
- プッシュサブスクリプションのConvex保存
- サブスクリプション管理API

#### Phase 3: 服薬リマインダー（3-4時間）
- 服薬スケジュールからの通知タイミング算出
- Convex Actionsでの定期実行（cron）
- 通知内容のカスタマイズ（薬名、用量、タイミング）
- タイムゾーン対応（JST固定）

#### iOS対応戦略
- オンボーディング時に「ホーム画面に追加」を促すUI
- チュートリアル画面でホーム画面追加の手順を表示
- アプリ起動時にPWAとして動作しているか検出
- PWAでない場合、バナー表示で追加を促す

---

## 理由

### 1. PWA + Web Push APIが最適な理由

#### アプリ特性との相性
お薬管理アプリは**継続利用が前提**：
- 毎日服薬記録をつける
- ホーム画面に追加する動機が十分にある
- iOS制限（ホーム画面追加必須）のハードルは低い

#### 技術的優位性
- ✅ **追加コストなし**: VAPID鍵は無料、外部サービス不要
- ✅ **クロスプラットフォーム**: Chrome、Edge、Firefox、Safari（iOS 16.4+）
- ✅ **Next.js/Convexと相性良好**: Service WorkerとConvex Actionsの組み合わせ
- ✅ **オフライン対応**: Service Workerでオフライン機能も実現可能
- ✅ **シンプルな実装**: Firebaseなど外部依存なし

#### iOS市場への対応
- iOS 16.4+は**ほぼ100%普及**（現在iOS 18が82%）
- 日本はiOSシェアが高い（37-69%）
- 技術的にはiOS対応済み

### 2. 段階的実装の利点

#### リスク分散
- Phase 1でPWA基礎を確立してから通知実装へ
- 各フェーズで動作確認・テストを実施
- 問題が発生しても影響範囲を限定

#### 学習コスト削減
- Service Worker、Web Push API、Convex Actionsを段階的に習得
- 各フェーズで知見を蓄積

#### 早期価値提供
- Phase 1完了時点でインストール可能なPWAに
- Phase 2完了時点でプッシュ通知基盤が完成
- Phase 3で服薬リマインダーを実現

---

## 利点

✅ **服薬アドヒアランス向上**: 服薬時刻に確実にリマインダーを送信
✅ **追加コストなし**: VAPID鍵は無料、外部サービス不要
✅ **クロスプラットフォーム**: iOS、Android、デスクトップすべて対応
✅ **オフライン対応**: Service WorkerでPWA化、オフライン機能も実現
✅ **技術スタックとの整合性**: Next.js、Convexと相性が良い
✅ **段階的実装**: リスクを分散し、各フェーズで価値を提供
✅ **インストール可能**: ホーム画面に追加できるネイティブアプリ的な体験

---

## 欠点と対応策

❌ **iOSではホーム画面追加が必須**: ブラウザで開いているだけでは通知を受け取れない
  → **対応**:
  - オンボーディング時に「ホーム画面に追加」を強調
  - チュートリアル画面で手順を画像付きで説明
  - アプリ起動時にPWA検出、未追加の場合はバナー表示
  - お薬管理アプリは継続利用前提なので、追加のハードルは低い

❌ **通知の確実性**: ネットワーク障害やデバイスオフライン時に通知が届かない可能性
  → **対応**:
  - Convex Actionsのリトライ機能を活用
  - 通知失敗時のログ記録とアラート
  - 次回アプリ起動時に未服薬を通知（フォールバック）
  - 重要な通知は複数回送信（例: 30分前、直前）

❌ **タイムゾーンの複雑性**: ユーザーの移動やタイムゾーン変更で通知時刻がずれる可能性
  → **対応**:
  - JST固定（日本国内向けアプリのため）
  - サーバー側（Convex Actions）でJST基準で通知スケジュール管理
  - 将来的にタイムゾーン設定を追加する余地を残す

❌ **Service Workerのキャッシュ管理**: 古いバージョンがキャッシュされる可能性
  → **対応**:
  - Service Workerのバージョニング戦略
  - キャッシュの適切な更新タイミング設定
  - Next.js公式のService Worker戦略に準拠

❌ **ブラウザごとの挙動差異**: Chrome、Safari、Firefoxで通知UIや挙動が異なる
  → **対応**:
  - 主要ブラウザでの動作確認をテスト計画に含める
  - ブラウザごとの差異をドキュメント化
  - 共通部分集合で実装、ブラウザ固有機能は使わない

---

## 代替案

### 代替案1: Capacitor（PWAラッパー）

**概要**: PWAコードをCapacitorでラップし、ネイティブアプリとしてApp Store配信

**メリット**:
- PWAコードをそのまま使える
- App Store配信可能
- ネイティブプッシュ通知が確実に動作
- iOS制限（ホーム画面追加必須）の回避

**デメリット**:
- ビルド/デプロイの複雑性が増す
- App Store審査が必要（時間とコスト）
- Apple Developer Program（年間14,800円）が必要
- PWAの利点（インストール不要、即座にアップデート）を失う

**却下理由**:
- 個人開発プロジェクトにとってコストと複雑性が過剰
- お薬管理アプリはホーム画面追加のハードルが低い（継続利用前提）
- PWAで十分に目的を達成できる
- 将来的にCapacitorへの移行は可能（段階的アプローチ）

### 代替案2: React Native / Expo

**概要**: React Nativeで最初から作り直し、完全ネイティブアプリとして実装

**メリット**:
- 完全ネイティブアプリ
- プッシュ通知が最も確実
- App StoreとGoogle Play両方で配信
- ネイティブ機能へのフルアクセス

**デメリット**:
- **最初から作り直し**（Next.js/Convexの実装を破棄）
- 開発コストが非常に高い
- メンテナンスコストも増加
- 現時点での実装（認証、データベース、UI）が無駄になる

**却下理由**:
- 開発コストが高すぎる
- 既存の実装を活かせない
- PWAで十分に目的を達成できる
- プロジェクトの現状（基盤が整った段階）と合わない

### 代替案3: Firebase Cloud Messaging (FCM)

**概要**: FirebaseのFCMを使ってプッシュ通知を実装

**メリット**:
- 実績のあるサービス
- 詳細なドキュメント
- 配信の信頼性が高い
- 分析機能

**デメリット**:
- 外部依存が発生（Firebase）
- 無料枠を超えるとコスト発生
- Web Push APIと比較して設定が複雑
- Service Workerは結局必要（PWA化は同じ）
- iOSの制限（ホーム画面追加必須）は同じ

**却下理由**:
- Web Push APIで十分（追加の外部サービス不要）
- コスト削減優先（個人開発）
- Firebase依存を避けたい（Convexをバックエンドとして採用済み）
- iOS制限の回避にはならない

---

## 実装計画

### Phase 1: PWA基礎（1-2時間）

#### タスク

1. **manifest.jsonの作成**
   - アプリ名: 「おくすりサポート」
   - 短縮名: 「おくすりサポート」
   - アイコン（192x192、512x512）
   - テーマカラー: プライマリカラーに統一
   - `display: "standalone"`（iOS Web Push必須）
   - `start_url: "/"`
   - `scope: "/"`

2. **Service Workerの基本設定**
   - `public/sw.js`の作成
   - キャッシュ戦略（Network First）
   - Service Worker登録スクリプト
   - 開発環境での無効化

3. **Next.js設定の調整**
   - `next.config.ts`でPWA対応設定
   - Service Workerのビルド設定

4. **動作確認**
   - Chrome DevToolsでmanifest確認
   - Service Worker登録確認
   - 「ホーム画面に追加」が表示されることを確認

#### 成功基準
- [ ] Lighthouseで「PWA」バッジが表示される
- [ ] Chrome/Edgeで「インストール」ボタンが表示される
- [ ] ホーム画面に追加後、standaloneモードで起動する

---

### Phase 2: プッシュ通知基盤（2-3時間）

#### タスク

1. **VAPID鍵の生成**
   ```bash
   npx web-push generate-vapid-keys
   ```
   - 公開鍵と秘密鍵を生成
   - 環境変数に保存（`.env.local`、Convex環境変数）

2. **Convexスキーマ追加**
   ```typescript
   // convex/schema.ts
   pushSubscriptions: defineTable({
     userId: v.string(),
     groupId: v.id("groups"),
     endpoint: v.string(),
     keys: v.object({
       p256dh: v.string(),
       auth: v.string(),
     }),
     userAgent: v.optional(v.string()),
     createdAt: v.number(),
     updatedAt: v.number(),
   })
   .index("by_userId", ["userId"])
   .index("by_groupId", ["groupId"])
   .index("by_endpoint", ["endpoint"])
   ```

3. **プッシュサブスクリプション管理API**
   - `convex/push/mutations.ts`: サブスクリプション登録・更新・削除
   - `convex/push/queries.ts`: サブスクリプション取得
   - `convex/push/actions.ts`: Web Push送信アクション

4. **フロントエンドのサブスクリプション実装**
   - Service Workerでのpush event受信
   - サブスクリプション登録UI
   - 通知許可リクエスト
   - サブスクリプションのConvexへの保存

5. **テスト通知の送信**
   - Convex Actionsから手動でテスト通知送信
   - 受信確認

#### 成功基準
- [ ] 通知許可を求めるダイアログが表示される
- [ ] 許可後、サブスクリプションがConvexに保存される
- [ ] Convex Actionsからテスト通知を送信できる
- [ ] 通知がデバイスに届く

---

### Phase 3: 服薬リマインダー（3-4時間）

#### タスク

1. **通知スケジュール管理**
   - 服薬スケジュール（`medicationSchedules`）から通知タイミングを算出
   - タイミング定義（朝: 8:00、昼: 12:00、夕: 18:00、就寝前: 21:00）
   - ユーザー設定でカスタマイズ可能に（将来拡張）

2. **Convex Scheduled Actionsの実装**
   ```typescript
   // convex/notifications/scheduler.ts
   export const checkMedicationReminders = internalAction({
     handler: async (ctx) => {
       // 1. 現在時刻（JST）を取得
       // 2. 該当する服薬スケジュールを検索
       // 3. 各患者のサブスクリプションを取得
       // 4. Web Push通知を送信
     }
   });
   ```

3. **Cron設定**
   ```typescript
   // convex/crons.ts
   export default cronJobs;
   cronJobs.interval(
     "medication-reminders",
     { minutes: 15 }, // 15分ごとに確認
     internal.notifications.scheduler.checkMedicationReminders
   );
   ```

4. **通知内容のカスタマイズ**
   ```json
   {
     "title": "服薬リマインダー",
     "body": "ロキソニン錠 1錠（朝）",
     "icon": "/icon-192x192.png",
     "badge": "/badge-72x72.png",
     "tag": "medication-reminder",
     "data": {
       "recordId": "...",
       "medicineId": "...",
       "timing": "morning"
     }
   }
   ```

5. **通知クリック時の動作**
   - Service Workerで通知クリックを処理
   - 該当する服薬記録画面へ遷移
   - 記録済みの場合は履歴表示

6. **タイムゾーン対応**
   - JST固定で実装
   - `date-fns-tz`を使用してタイムゾーン変換
   - サーバー側（Convex）でJST基準で時刻判定

#### 成功基準
- [ ] 設定した時刻に服薬リマインダーが届く
- [ ] 通知内容に薬名・用量・タイミングが表示される
- [ ] 通知クリックでアプリが開き、該当記録画面に遷移する
- [ ] タイムゾーンが正しく処理される（JST基準）

---

### Phase 4: iOS対応UI（1-2時間）

#### タスク

1. **オンボーディング画面の拡張**
   - 「ホーム画面に追加」の手順を説明
   - iOSとAndroidで手順を分岐表示
   - スクリーンショット付きチュートリアル

2. **PWA検出とバナー表示**
   ```typescript
   // PWAとして動作しているか検出
   const isPWA = window.matchMedia('(display-mode: standalone)').matches;

   if (!isPWA && isIOS) {
     // 「ホーム画面に追加」バナーを表示
   }
   ```

3. **設定画面での通知管理**
   - 通知の有効/無効切り替え
   - 通知時刻のカスタマイズ（将来拡張）
   - サブスクリプション状況の表示

#### 成功基準
- [ ] iOSユーザーにホーム画面追加手順が表示される
- [ ] PWAでない場合、バナーでホーム画面追加を促す
- [ ] 設定画面で通知の有効/無効を切り替えられる

---

## 技術的考慮事項

### 1. Service Workerのライフサイクル

- **インストール**: 初回訪問時、または更新時
- **アクティベート**: 古いService Workerの置き換え
- **フェッチ**: ネットワークリクエストのインターセプト
- **プッシュ**: プッシュ通知の受信

**対応**:
- Service Workerのバージョニング戦略（キャッシュ名にバージョン）
- `skipWaiting()`と`clients.claim()`の適切な使用
- 古いキャッシュの削除

### 2. VAPID鍵の管理

- **公開鍵**: フロントエンドで使用（環境変数）
- **秘密鍵**: Convex Actionsで使用（Convex環境変数）
- **セキュリティ**: 秘密鍵は絶対に公開しない

**対応**:
- `.env.local`と`.env.example`の適切な分離
- Convex環境変数での秘密鍵管理
- 本番環境とdev環境で鍵を分離

### 3. 通知の確実性

**リスク**:
- ネットワーク障害
- デバイスオフライン
- サブスクリプションの有効期限切れ
- ブラウザのバックグラウンド制限

**対応**:
- Convex Actionsのリトライ機能
- 通知失敗時のログ記録
- 次回起動時のフォールバック通知
- 重要な通知は複数回送信（30分前、直前）

### 4. タイムゾーン管理

**方針**:
- JST固定（日本国内向けアプリ）
- サーバー側（Convex Actions）でJST基準で時刻判定
- `date-fns-tz`を使用

**対応**:
```typescript
import { formatInTimeZone } from 'date-fns-tz';

const jstNow = formatInTimeZone(new Date(), 'Asia/Tokyo', 'HH:mm');
```

### 5. パフォーマンス最適化

- Service Workerのキャッシュ戦略: Network First（最新データ優先）
- 静的アセットのキャッシュ: Cache First（高速読み込み）
- Convex Actionsのバッチ処理: 複数通知を一度に送信

---

## 影響範囲

### 影響を受けるコンポーネント

- **フロントエンド**:
  - `public/manifest.json`（新規）
  - `public/sw.js`（新規）
  - オンボーディング画面（拡張）
  - 設定画面（通知管理）
  - ヘッダー（PWAバナー）

- **バックエンド（Convex）**:
  - `convex/schema.ts`（pushSubscriptionsテーブル追加）
  - `convex/push/`（新規ディレクトリ）
  - `convex/notifications/`（新規ディレクトリ）
  - `convex/crons.ts`（新規）

- **環境設定**:
  - `.env.local`（VAPID公開鍵）
  - Convex環境変数（VAPID秘密鍵）

### 影響を受けるワークフロー

- **ユーザーオンボーディング**: ホーム画面追加の手順が追加
- **服薬記録**: 通知から直接記録画面へ遷移可能
- **アプリインストール**: PWAとしてインストール可能に

---

## リスクと軽減策

| リスク | 発生確率 | 影響度 | 軽減策 |
|--------|----------|--------|--------|
| iOS未対応ユーザー（iOS < 16.4） | 低 | 中 | バージョン検出、代替案（メール通知など）提示 |
| ホーム画面追加を拒否 | 中 | 高 | オンボーディングで強調、チュートリアル充実 |
| 通知が届かない | 低 | 高 | リトライ機能、フォールバック通知、ログ記録 |
| Service Workerのバグ | 中 | 高 | テスト充実、段階的ロールアウト |
| VAPID鍵の漏洩 | 低 | 高 | 環境変数管理、.gitignore設定、定期ローテーション |
| タイムゾーンのずれ | 低 | 中 | JST固定、サーバー側で時刻判定 |

---

## 成功基準

### Phase 1完了時
- [ ] Lighthouseで「PWA」バッジが表示される
- [ ] ホーム画面に追加できる
- [ ] standaloneモードで起動する

### Phase 2完了時
- [ ] 通知許可を取得できる
- [ ] サブスクリプションがConvexに保存される
- [ ] テスト通知が届く

### Phase 3完了時
- [ ] 服薬時刻に通知が届く
- [ ] 通知内容が適切（薬名、用量、タイミング）
- [ ] 通知クリックで該当画面に遷移する

### Phase 4完了時
- [ ] iOSユーザーにホーム画面追加手順が表示される
- [ ] PWAバナーが適切に表示される
- [ ] 設定画面で通知管理ができる

### 全体の成功基準
- [ ] iOS、Android、デスクトップすべてで通知が動作する
- [ ] 通知到達率 > 95%（ネットワーク正常時）
- [ ] ユーザーがホーム画面に追加する率 > 70%
- [ ] 服薬アドヒアランス率の向上が確認できる

---

## 関連ドキュメント

- [プロジェクト概要](../project.md)
- [アーキテクチャ](../architecture.md)
- [服薬管理機能仕様](../spec/features/medication.md)
- [処方箋管理機能の導入決定記録](./2025-10-26-prescription-management.md)

---

## 承認

| 役割 | 名前 | 日付 |
|------|------|------|
| 提案者 | AI | 2025-11-20 |
| レビュー | 開発者 | 2025-11-20 |
| 承認者 | 開発者 | 2025-11-20 |

---

## 実装状況

1. ⏳ Phase 1: PWA基礎
2. ⏳ Phase 2: プッシュ通知基盤
3. ⏳ Phase 3: 服薬リマインダー
4. ⏳ Phase 4: iOS対応UI

---

## 更新履歴

- 2025-11-20: 初版作成（decision-assistantスキルで作成）
