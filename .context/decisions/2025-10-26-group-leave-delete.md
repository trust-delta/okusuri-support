# ADR: グループ脱退・削除機能の導入

**日付**: 2025年10月26日
**ステータス**: 提案中
**決定者**: 開発者

---

## 背景

現在のグループ機能には、ユーザーがグループから離れる手段が提供されていない。テスト運用を通じて、以下の課題が明らかになった：

1. **脱退機能の欠如**: メンバーがグループから離れたい場合の手段がない
2. **削除権限の制約**: グループの削除は作成者のみに限定され、最後の1人になった場合でも作成者でないと削除できない
3. **データ保持の問題**: ユーザーが一度脱退すると、再参加時に以前のデータが失われてしまう

### 現在の実装の問題点

```typescript
// 現在：作成者のみが削除可能
groups.mutations.remove: {
  // 権限チェック: createdBy === currentUserId
}
```

この方法では：
- グループから脱退する手段がない
- 最後の1人になっても作成者でないと削除できない
- 再参加時に以前の服薬記録が引き継がれない

---

## 決定

### グループ脱退・削除機能を導入し、柔軟なメンバー管理を実現する

**グループ脱退**:
- 2人以上のメンバーがいる場合、誰でも脱退可能
- 脱退しても関連データは論理削除で保持
- 再招待で参加した場合、以前のデータが復元される

**グループ削除**:
- 最後の1人のメンバーのみが削除可能（作成者かどうかは問わない）
- 削除時は全データを論理削除
- 将来的に完全削除機能も追加可能

---

## 理由

### 1. ユーザーの自由度向上

実際の利用シーンに即した柔軟性：

```
シナリオ1: 支援者の交代
  患者Aと支援者Bがグループを運用
    ↓
  支援者Bが支援を終了（脱退）
    ↓
  新しい支援者Cを招待
    ↓
  後日、支援者Bが再参加（データが復元される）

シナリオ2: 一時的な利用終了
  ユーザーが一時的にアプリを使わなくなる
    ↓
  グループから脱退（データは保持）
    ↓
  数ヶ月後、再度使いたくなる
    ↓
  再招待で参加（以前の服薬記録が全て復元される）
```

### 2. データの永続性

脱退後もデータを保持することで：
- **再参加時の復元**: 以前の服薬記録や処方箋がそのまま使える
- **統計の正確性**: 過去のデータが失われず、継続的な服薬管理が可能
- **心理的安心感**: 「脱退してもデータは消えない」という安心感

### 3. 権限モデルのシンプル化

作成者という概念から、「最後の1人」という実態に即した権限へ：
- **公平性**: 作成者でなくても最後の1人なら削除できる
- **実用性**: グループの責任者が変わっても柔軟に対応
- **直感性**: 「誰もいないグループは削除できる」という分かりやすいルール

### 4. 論理削除との一貫性

既に実装されている処方箋の論理削除と同じ思想：
- **誤操作からの保護**: 脱退や削除を誤っても復元可能
- **監査証跡**: 誰がいつ脱退したかの履歴を保持
- **データ整合性**: 過去の統計や記録が正確に保たれる

---

## 利点

✅ **柔軟なメンバー管理**: ユーザーが自由に脱退・再参加できる
✅ **データの永続性**: 脱退後も再参加時にデータが復元される
✅ **権限の公平性**: 最後の1人なら誰でも削除できる
✅ **一貫性**: 処方箋削除と同じ論理削除の思想
✅ **安心感**: データが失われない安心感
✅ **統計の正確性**: 過去のデータが保持される

---

## 欠点

❌ **実装コスト**: スキーマ変更、API追加、UI実装が必要
  → **対応**: 段階的に実装（バックエンド → フロントエンド）

❌ **データ保持によるストレージ消費**: 脱退したユーザーのデータも保持する
  → **対応**: 初期は無期限保持、将来的にクリーンアップ機能を検討

❌ **Patient role制約との整合性**: 再参加時にroleを自由に変更できるようにすると、制約と矛盾する可能性
  → **対応**: 招待時の許可ロール制限で解決済み（問題なし）

---

## 代替案

### 1. 脱退機能のみ実装（削除は作成者のみ）

```typescript
// 脱退のみを追加
groups.mutations.leaveGroup
// 削除は現状維持（作成者のみ）
groups.mutations.remove
```

**メリット**:
- 実装が簡単
- 既存の権限モデルを維持

**デメリット**:
- 最後の1人が作成者でない場合、グループを削除できない
- 権限モデルが複雑（作成者と一般メンバーで異なるルール）

**却下理由**: ユーザー体験が悪く、実用的でない

### 2. 脱退時にデータを削除

脱退時に関連データを全て削除する。

**メリット**:
- ストレージ消費が少ない
- 実装がシンプル

**デメリット**:
- 再参加時にデータが復元されない
- 誤操作時のリカバリーができない
- ユーザーが脱退を躊躇する

**却下理由**: サービスの価値を大きく損なう

### 3. グループの「アーカイブ」機能

削除の代わりにアーカイブ機能を提供。

**メリット**:
- 削除せずに非表示にできる
- 後で復元可能

**デメリット**:
- 概念が複雑（アーカイブ vs 削除）
- 脱退機能との関係が不明瞭

**却下理由**: 論理削除で同じことが実現できる

---

## 実装計画

### Phase 1: データモデルとバックエンド

**1. スキーマの変更**

```typescript
// groupMembers テーブル
{
  leftAt?: v.number(),              // 脱退日時（論理削除）
  leftBy?: v.string(),              // 脱退実行者のuserId
}

// groups テーブル
{
  deletedAt?: v.number(),           // グループ削除日時（論理削除）
  deletedBy?: v.string(),           // 削除実行者のuserId
}
```

**インデックス追加**:
- `by_groupId_leftAt`: アクティブメンバーのフィルタリング用

**2. API実装**

```typescript
// グループ脱退
groups.mutations.leaveGroup: {
  args: { groupId: Id<"groups"> },
  returns: Result<void>
}

// グループ削除（既存のremoveを置き換え）
groups.mutations.deleteGroup: {
  args: { groupId: Id<"groups"> },
  returns: Result<void>
}

// 再参加時のデータ復元（既存acceptを拡張）
invitations.mutations.accept: {
  // 既存のgroupMembersレコードを検索
  // leftAt != undefined なら復元
}
```

**3. クエリフィルタの追加**

全てのグループ関連クエリに論理削除フィルタを追加：
```typescript
// groupMembers
.filter((q) => q.eq(q.field("leftAt"), undefined))

// groups
.filter((q) => q.eq(q.field("deletedAt"), undefined))
```

**4. activeGroupId の自動切り替え**

脱退・削除後に他のグループに自動切り替え：
```typescript
// 優先順位:
1. 他に所属しているグループがあれば、最も最近参加したグループ
2. 所属グループがない場合は null
3. フロントエンドでオンボーディング画面にリダイレクト
```

### Phase 2: フロントエンド

**1. グループ設定画面の作成** (`/dashboard/group/settings`)

- グループ名・説明の編集
- メンバー一覧
- 招待リンク生成
- **危険な操作エリア**:
  - 「グループから脱退」ボタン（2人以上の場合のみ表示）
  - 「グループを削除」ボタン（最後の1人の場合のみ表示）

**2. 確認ダイアログの実装**

脱退時:
```
グループから脱退しますか?

脱退後も、再度招待されることで以前のデータを保持したまま再参加できます。

[キャンセル] [脱退する]
```

削除時:
```
グループを削除しますか?

このグループに関連する全てのデータ（処方箋、服薬記録など）が削除されます。
この操作は元に戻すことができません。

[キャンセル] [削除する]
```

**3. エラーハンドリング**

- 最後の1人が脱退しようとした場合: 「最後の1人のメンバーは脱退できません。グループを削除してください」
- メンバーが複数いるグループを削除しようとした場合: 「メンバーが複数いるグループは削除できません。先に脱退してください」

### Phase 3: テストとドキュメント

**1. ユニットテスト**
- 脱退のバリデーション（最後の1人チェック）
- 削除のバリデーション（メンバー数チェック）
- 再参加時のデータ復元
- activeGroupId の自動切り替え

**2. 統合テスト**
- 脱退 → 再参加 → データ復元の一連のフロー
- グループ削除 → 関連データの論理削除
- 論理削除フィルタの動作確認

**3. E2Eテスト**
- グループ作成 → メンバー追加 → 脱退 → 削除のフロー
- 脱退 → 再招待 → 再参加 → データ復元のフロー

**4. ドキュメント更新**
- `.context/specs/features/group.md` の更新
- `.context/decisions/2025-10-26-group-leave-delete.md` の作成（このドキュメント）

---

## 技術的考慮事項

### 1. Patient role制約との整合性

現在の仕様では、1グループに1人のPatientのみ許可されている。再参加時にroleを自由に変更できるようにすると、以下のシナリオが考えられる：

```
1. PatientとしてグループAに参加
2. 脱退
3. 別のユーザーがPatientとしてグループAに参加
4. 元のユーザーが再びPatientとしてグループAに参加しようとする
```

**対応**: 招待時の許可ロール制限で解決済み
- 招待コード生成時に `allowedRoles` を指定
- 既にPatientが存在する場合は、Supporterのみ許可する招待コードを発行
- ユーザーからの確認により、この対応で問題なし

### 2. データ保持期間

論理削除されたデータは無期限で保持する方針。

**理由**:
- ユーザーが数ヶ月後に再参加する可能性がある
- ストレージコストは現時点では問題ない
- 将来的にクリーンアップ機能を追加可能

**将来的な改善案**:
- 管理画面で論理削除されたデータを確認・完全削除
- 一定期間（例: 1年）経過後に自動クリーンアップ
- ユーザーによる明示的な完全削除機能

### 3. グループ削除の復元機能

Phase 1では実装しないが、論理削除のため将来的に実装可能。

**実装する場合のAPI**:
```typescript
groups.mutations.restoreGroup: {
  args: { groupId: Id<"groups"> },
  returns: Result<void>
}
```

**UI**: 削除されたグループ一覧ページを追加し、復元ボタンを配置

**ユーザーからの確認**: 最終的に実装されるのであれば、必ずしもPhase 1でなくてもOK

### 4. カスケード削除の範囲

グループ削除時に論理削除する関連データ：
```typescript
- groupMembers（全メンバー）
- groupInvitations（全招待）
- prescriptions（全処方箋）
  ├─ medicines（全薬）
  ├─ medicationSchedules（全スケジュール）
  └─ medicationRecords（全記録）
```

全てを一度に論理削除し、復元時も全て復元する。

---

## セキュリティ考慮事項

### 1. 権限チェック

**脱退**:
- グループメンバーであることを確認
- 最後の1人でないことを確認

**削除**:
- グループメンバーであることを確認
- 最後の1人であることを確認

### 2. データアクセス制御

論理削除されたgroupMembersのユーザーは：
- グループのデータにアクセスできない
- 再参加するまでは非メンバーとして扱われる

### 3. 監査証跡

以下の情報を記録：
- `leftAt`: 脱退日時
- `leftBy`: 脱退実行者（自己脱退の場合は本人のuserId）
- `deletedAt`: グループ削除日時
- `deletedBy`: 削除実行者のuserId

---

## 制限事項

### Phase 1 での制限

- **グループ削除の復元機能**: 実装しない（将来的に実装予定）
- **完全削除機能**: 実装しない（将来的に実装予定）
- **データクリーンアップ**: 無期限保持（将来的に検討）

### 既存の制限の維持

- **Patient role制約**: 1グループに1人のPatient（維持）
- **招待コード有効期限**: 7日間（維持）
- **メンバー数上限**: なし（維持）

---

## 関連ドキュメント

- [グループ管理機能仕様](../specs/features/group.md)
- [処方箋管理機能の導入 ADR](./2025-10-26-prescription-management.md)
- [アーキテクチャ](../architecture.md)
- [プロジェクト概要](../project.md)

---

## 承認

| 役割 | 名前 | 日付 |
|------|------|------|
| 提案者 | AI | 2025年10月26日 |
| レビュー | 開発者 | - |
| 承認者 | 開発者 | - |

---

## 次のステップ

1. ✅ ADR作成（このドキュメント）
2. ⏳ ユーザーによるレビューと承認
3. ⏳ スキーマの変更とマイグレーション
4. ⏳ バックエンドAPI実装
5. ⏳ フロントエンドUI実装
6. ⏳ テスト実装
7. ⏳ 仕様書の更新

---

## 更新履歴

### 2025年10月26日 - 初版作成

テスト運用を通じて明らかになったグループ脱退・削除機能の必要性に基づき、ADRを作成。

**主な決定事項**:
- 2人以上のグループからは脱退のみ可能
- 最後の1人のみがグループを削除可能
- 脱退後も再参加時にデータが復元される
- 論理削除による実装
- Phase 1では復元機能は実装しない
