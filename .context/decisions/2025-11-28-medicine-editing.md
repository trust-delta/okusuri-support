# 決定記録: 処方箋内の薬の編集・削除機能

**日付**: 2025年11月28日
**ステータス**: 承認済み
**決定者**: 開発者

---

## 背景

処方箋管理機能の実装後、以下の課題が明らかになった：

1. **薬の編集・削除ができない**: 処方箋作成後に薬を追加・編集・削除するUIがない
2. **入力ミスへの対応**: 薬の入力を間違えた場合、処方箋ごと削除して作り直す必要がある
3. **処方箋の増加問題**: 複製機能はあるが、小さな変更でも新しい処方箋が増え続ける

### 検討した課題

「記録が始まった処方箋の薬を変更すると、過去の統計に影響する」という問題に対して、複数のアプローチを検討：

- A. 常に編集可能（統計はスナップショット）
- B. 複製で対応（現状維持）
- C. 未記録のみ編集可能 + UI改善
- D. 薬単位で編集可否を判断
- **E. 薬削除時に関連記録も削除（採用）**

---

## 決定

### 処方箋内の薬は自由に編集・削除可能とする

薬を削除する際、その薬に紐付く服薬記録も一緒に論理削除する。

---

## 仕様

### 操作と挙動

| 操作 | 挙動 |
|------|------|
| 薬の追加 | 常に可能 |
| 薬の編集 | 常に可能（名前・説明・用量・タイミング） |
| 薬の削除 | 関連する記録も論理削除（確認ダイアログ表示） |

### 薬削除時の確認ダイアログ

記録がある場合：
```
「ロキソニン」を削除しますか？

この薬に紐付く服薬記録（12件）も削除されます。
削除した記録は履歴から確認できます。

[キャンセル] [削除]
```

記録がない場合：
```
「ロキソニン」を削除しますか？

[キャンセル] [削除]
```

### 技術的な実装

既存の `deletePrescription` と同様の論理削除パターンを使用：

1. 薬（medicines）を論理削除
2. 関連するスケジュール（medicationSchedules）を論理削除
3. 関連する記録（medicationRecords）を論理削除

### 復元について

- 論理削除されたデータは `medicationRecordsHistory` に保存される
- 処方箋をゴミ箱から復元すると、関連データも復元される
- 薬単体の復元UIは現時点では不要（処方箋単位で管理）

---

## 理由

### 採用理由

1. **統計の整合性**: 薬がないのに記録だけ残る問題を回避
2. **ユーザーフレンドリー**: 自由に編集・削除できる
3. **履歴から復元可能**: 完全削除ではなく論理削除
4. **シンプルな実装**: 既存の処方箋削除と同じパターン

### 却下した代替案

**A. 常に編集可能（統計はスナップショット）**
- 却下理由: 実装が複雑（スキーマ変更・既存データ移行が必要）

**B. 複製で対応（現状維持）**
- 却下理由: ユーザー操作が煩雑、処方箋が増え続ける

**C. 未記録のみ編集可能 + UI改善**
- 却下理由: ルールが分かりにくく、ユーザー体験が悪い

**D. 薬単位で編集可否を判断**
- 却下理由: 薬ごとに挙動が異なるため混乱を招く

---

## 影響範囲

### 新規実装が必要

- `medicines.mutations.deleteMedicine` - 薬の削除mutation
- `medicines.mutations.updateMedicine` - 薬の編集mutation
- `medicines.mutations.addMedicine` - 薬の追加mutation
- `medicines.queries.getMedicineRecordCount` - 記録件数取得query
- 処方箋詳細画面の薬編集UI

### 既存機能への影響

- 処方箋詳細表示に編集・削除ボタンを追加
- 処方箋復元時の挙動は変更なし

---

## 実装計画

### フェーズ1: バックエンド実装
1. `deleteMedicine` mutation（記録も一緒に論理削除）
2. `updateMedicine` mutation（名前・説明・用量・タイミング）
3. `addMedicineToPrescription` mutation（既存処方箋への薬追加）
4. `getMedicineRecordCount` query（削除確認用）

### フェーズ2: フロントエンド実装
1. 処方箋詳細画面に薬の編集・削除ボタン追加
2. 薬削除確認ダイアログ（記録件数表示）
3. 薬編集ダイアログ
4. 薬追加ダイアログ

---

## 関連ドキュメント

- [処方箋管理機能の導入決定記録](./2025-10-26-prescription-management.md)
- [服薬管理機能仕様](../specs/features/medication.md)

---

## 承認

| 役割 | 名前 | 日付 |
|------|------|------|
| 提案者 | AI | 2025-11-28 |
| レビュー | 開発者 | 2025-11-28 |
| 承認者 | 開発者 | 2025-11-28 |
