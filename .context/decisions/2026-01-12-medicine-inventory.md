# 薬の残量管理機能の導入

**日付**: 2026年1月12日
**ステータス**: 実装完了
**決定者**: 開発チーム

## 背景

競合分析の結果、薬の残量管理機能が多くの競合アプリで提供されていることが判明。しかし、単なる残量追跡だけでは差別化が困難。

服薬管理を必要とする患者（特に精神疾患患者）の特性を考慮すると、以下のケースへの対応が重要：
- オーバードーズ（過剰服用）
- 間違えて多く飲んでしまった
- 紛失してしまった

これらの「予定外消費」を追跡し、支援者に通知することで差別化を図る。

## 決定事項

### 1. データモデル

3つの新規テーブルを追加：

| テーブル | 用途 |
|----------|------|
| `medicineInventory` | 薬ごとの残量・警告閾値 |
| `medicineConsumptionRecords` | 消費記録（予定/追加/紛失/補充/調整） |
| `inventoryAlerts` | アラート（残量不足/予定外消費/過剰服用） |

### 2. 消費タイプの設計

| タイプ | 説明 | 自動生成 |
|--------|------|----------|
| `scheduled` | 予定通りの服薬 | Yes（服薬記録時） |
| `extra` | 追加服用 | No |
| `lost` | 紛失 | No |
| `adjustment` | 調整（棚卸し） | No |
| `refill` | 補充 | No |

### 3. アラートの設計

| タイプ | トリガー | 重要度 |
|--------|----------|--------|
| `low_stock` | 残量が閾値以下 | warning |
| `unexpected_consumption` | extra/lost記録時 | warning/critical |
| `overdose_warning` | 短時間で多量消費 | critical |

### 4. 既存機能との連携

服薬記録（`recordSimpleMedication`）で `status="taken"` の場合：
1. 残量を自動減少
2. `scheduled` 消費記録を自動作成
3. 閾値チェック → 必要に応じてアラート生成

### 5. UI設計

- `/inventory` ページを新規作成
- ダッシュボードにはInventoryBadgeで残量警告を表示
- 消費記録ダイアログで予定外消費を記録

## 理由

### なぜ予定外消費を追跡するか

1. **患者の安全**: オーバードーズを早期発見
2. **支援者の安心**: 異常をリアルタイムで把握
3. **差別化**: 競合にない機能
4. **記録の正確性**: 残量の不一致原因を把握

### なぜ消費タイプを分けるか

1. 統計分析が可能（どの消費タイプが多いか）
2. 適切なアラート生成が可能
3. ユーザーの自己認識を促す

## 代替案

### 案A: シンプルな残量追跡のみ
- メリット: 実装が簡単
- デメリット: 差別化できない、予定外消費を追跡できない

### 案B: 全消費を手動記録
- メリット: 完全な追跡が可能
- デメリット: ユーザー負担が大きい

### 採用: 案C（ハイブリッド）
- 服薬記録時は自動で消費記録
- 予定外消費は手動で記録
- バランスが取れている

## 影響

### 変更が必要なファイル

**スキーマ**:
- `convex/medications/schema.ts` - 3テーブル追加

**API**:
- `convex/medications/inventory/` - 新規
- `convex/medications/alerts/` - 新規
- `convex/medications/records/mutations.ts` - 連携追加

**UI**:
- `app/(private)/inventory/` - 新規ページ
- `app/_shared/features/inventory/` - 新規コンポーネント群

### 既存機能への影響

- 服薬記録機能に残量連携を追加（オプション機能、既存動作に影響なし）

## 実装計画

1. **Phase 1**: スキーマとAPI基盤 ✅
2. **Phase 2**: 既存機能との連携 ✅
3. **Phase 3**: アラート機能 ✅
4. **Phase 4**: UI実装 ✅
5. **Phase 5**: テスト・ドキュメント ✅

## 参考資料

- [競合分析レポート](../reports/2026-01-11-competitor-analysis.md)
- [残量管理機能仕様書](../specs/features/medicine-inventory.md)
