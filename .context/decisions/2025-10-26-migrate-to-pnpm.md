# ADR: npmからpnpmへの移行

**日付**: 2025年10月26日
**ステータス**: 承認済み
**決定者**: 開発者

---

## 背景

プロジェクトではnpmをパッケージマネージャーとして使用していたが、以下の課題が存在：

1. **インストール速度**: node_modulesの構造が非効率で、インストールに時間がかかる
2. **ディスク容量**: 各プロジェクトで依存関係を完全に複製するため、ディスク使用量が大きい
3. **厳密性の欠如**: 依存関係の解決が緩く、異なる環境で異なるバージョンがインストールされる可能性がある

---

## 決定

### パッケージマネージャーをpnpmに移行

npmからpnpmへ完全に移行し、プロジェクトの依存関係管理を改善する。

---

## 理由

### 1. 高速なインストール
- グローバルストアを使用した効率的な依存関係管理
- ハードリンクによる高速なnode_modules構築

### 2. ディスク容量の節約
- 依存関係をグローバルストアに一度だけ保存
- プロジェクト間で依存関係を共有

### 3. 厳密な依存関係管理
- flat node_modulesを使用せず、依存関係を厳密に管理
- package.jsonに明示的に記載されていない依存関係へのアクセスを防止

### 4. モノレポサポート
- 将来的にモノレポ構成への移行を検討する場合、pnpmは優れたサポートを提供

---

## 利点

✅ **高速**: npmと比較して最大2倍高速なインストール
✅ **省スペース**: ディスク使用量を大幅に削減
✅ **厳密性**: 依存関係の解決が厳格で、予期しない動作を防止
✅ **互換性**: npmと同じpackage.jsonを使用

---

## 欠点

❌ **学習コスト**: チーム全体がpnpmのコマンドを習得する必要がある
  → **対応**: pnpmのコマンドはnpmとほぼ同じため、学習コストは最小限

❌ **CI/CD設定の変更**: GitHub Actionsなどでpnpmのセットアップが必要
  → **対応**: 将来のCI/CD構築時に対応

---

## 代替案

### 1. npmのまま継続
**却下理由**: インストール速度とディスク容量の課題が解決されない

### 2. yarnへの移行
**却下理由**: pnpmの方がディスク効率と厳密性の面で優れている

### 3. Bun
**却下理由**: まだ安定性に課題があり、本番環境での採用はリスクが高い

---

## 実装

### 実施済み ✅

1. **pnpmのインストール**
   ```bash
   npm install -g pnpm
   ```

2. **既存のnpm関連ファイルの削除**
   - `package-lock.json`の削除
   - `node_modules`の削除

3. **pnpmによる依存関係のインストール**
   ```bash
   pnpm install
   ```

4. **.gitignoreの更新**
   - `package-lock.json`と`yarn.lock`を除外リストに追加
   - `pnpm-lock.yaml`はコミット対象として保持

5. **動作確認**
   - ビルドの成功を確認

### 今後の対応

- CI/CD環境でpnpmを使用するように設定（GitHub Actions構築時）
- READMEにpnpm使用を明記（必要に応じて）

---

## 移行手順

将来的に他の環境でも同様の移行を行う場合の手順：

```bash
# 1. pnpmをインストール
npm install -g pnpm

# 2. 既存のnode_modulesとロックファイルを削除
rm -rf node_modules package-lock.json

# 3. pnpmで依存関係をインストール
pnpm install

# 4. 動作確認
pnpm run build
```

---

## 関連ドキュメント

- [プロジェクト概要](../project.md)
- [技術スタック](../tech-stack.md)

---

## 承認

| 役割 | 名前 | 日付 |
|------|------|------|
| 提案者 | 開発者 | 2025-10-26 |
| 実施者 | AI | 2025-10-26 |
