# 仕様書の更新

既存仕様書を実装変更に合わせて更新します。

## 実行フロー

### 1. 初期化フェーズ

#### 1-1. 現在日時の取得
```bash
TZ='Asia/Tokyo' date '+%Y年%m月%d日 %H:%M:%S JST'
```
- JST日時を「YYYY年MM月DD日」形式で取得
- 仕様書の「最終更新」を更新

#### 1-2. 既存仕様書の読み込み
更新対象の仕様書を Read ツールで読み込み：
- 現在の内容を把握
- 更新履歴を確認
- 関連ドキュメントを確認

#### 1-3. 関連実装ファイルの確認（オプション）

**提案タイミング**: 更新時のみ提案

ユーザーが希望する場合、関連実装ファイルを確認：

**スクリプトで関連実装ファイル検索**:
```bash
# 機能名から関連ファイルを検索（最大5件）
./.claude/skills/spec-assistant/scripts/spec-find-impl.sh medication 5
```

**確認範囲**: 最大 2-5 個の主要ファイルのみ
- 機能仕様書更新時: `src/features/[feature]/components/`, `convex/[feature]/`
- API仕様書更新時: `convex/[feature]/queries.ts`, `convex/[feature]/mutations.ts`

**確認内容**:
- 仕様書に記載されている関数・コンポーネントが実装に存在するか
- 引数・戻り値の型が一致しているか
- 明らかな乖離があれば指摘

**注意**: プロジェクト全体の網羅的スキャンは行いません（軽量な確認のみ）

---

### 2. 対話フェーズ

#### ステップ1: 変更内容の確認

「何を変更しましたか？」
- 新規追加した機能・API
- 変更した機能・API
- 削除した機能・API

#### ステップ2: 影響範囲の確認

「他のセクションへの影響はありますか？」
- データモデルの変更
- 権限設計の変更
- API設計の変更
- UI/UX要件の変更

#### ステップ3: 実装状況の更新

「実装状況を更新しますか？」
- 未実装 → 進行中
- 進行中 → 完了
- 新規追加した要件の実装状況

---

### 3. 更新フェーズ

#### 3-1. 変更内容の反映

既存仕様書を Edit ツールで更新：
- 新規セクションの追加
- 既存セクションの更新
- 実装状況の更新

#### 3-2. 最終更新日の更新

「最終更新」セクションを現在日時に更新

#### 3-3. 更新履歴の追加（オプション）

重要な変更の場合、「更新履歴」セクションに追記：
```markdown
## 更新履歴

- **2025年11月16日**: 通知設定機能を追加、リマインダーロジックを変更
- **2025年10月20日**: 初版作成
```

---

### 4. バリデーションフェーズ

更新した仕様書が以下の基準を満たしているか確認：

- [ ] 変更内容が正しく反映されているか
- [ ] 最終更新日が更新されているか
- [ ] 実装状況が正しく設定されているか
- [ ] 他のセクションとの一貫性が保たれているか
- [ ] 必須セクションが維持されているか

**スクリプトで検証**:
```bash
./.claude/skills/spec-assistant/scripts/spec-validate.sh .context/specs/features/notification.md
```

---

### 5. 出力フェーズ

Edit ツールで既存ファイルを更新し、ユーザーに確認を促します。

---

## 軽量な整合性確認（オプション）

### 確認タイミング

仕様書更新時のみ提案し、ユーザーが希望する場合に実行

### 確認範囲

**最大2-5個の主要ファイルのみ**（大規模スキャンは行わない）

### 確認内容

- 仕様書に記載されている関数・コンポーネントが実装に存在するか
- 引数・戻り値の型が一致しているか
- 明らかな乖離があれば指摘

### 大規模整合性チェックは範囲外

プロジェクト全体の仕様書と実装を網羅的にスキャンするのは、このスキルの範囲外です。

---

## 更新パターン

### パターン1: 新機能の追加

**変更内容**:
- 「機能要件」セクションに新規要件を追加
- データモデルに新規フィールドを追加
- API設計に新規関数を追加

**例**:
```markdown
## 機能要件

### 通知設定
- [ ] **未実装** - 通知時間のカスタマイズ（優先度: 中）
- [ ] **未実装** - 通知音の選択（優先度: 低）
```

### パターン2: 既存機能の変更

**変更内容**:
- 該当セクションの内容を更新
- 影響を受ける他のセクションも更新

**例**:
```markdown
## データモデル

\`\`\`typescript
interface Notification {
  _id: Id<"notifications">;
  userId: Id<"users">;
  message: string;
  isRead: boolean;
  // 追加: 通知タイプ
  type: "medication" | "reminder" | "group";
  _creationTime: number;
}
\`\`\`
```

### パターン3: 実装状況の更新

**変更内容**:
- 実装状況を「未実装」→「進行中」→「完了」に更新

**例**:
```markdown
## 機能要件

### 通知機能
- [x] **完了** - 服薬時間の通知（優先度: 高）
  ~~- [ ] **未実装**~~
  → 実装完了（2025年11月16日）
```

---

## 注意事項

1. **実装との同期**: 実装を変更したら必ず仕様書を更新（CLAUDE.mdの重要ルール）
2. **最終更新日**: 更新時は必ず「最終更新」を更新
3. **一貫性**: 他のセクションとの一貫性を保つ
4. **テンプレート準拠**: プロジェクト固有のテンプレートに100%準拠
5. **軽量な確認**: 大規模スキャンは行わず、必要最小限の確認のみ
