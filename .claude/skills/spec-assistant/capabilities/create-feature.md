# 機能仕様書の作成

新機能の仕様書を対話形式で作成します。

## 実行フロー

### 1. 初期化フェーズ

#### 1-1. 現在日時の取得
```bash
TZ='Asia/Tokyo' date '+%Y年%m月%d日 %H:%M:%S JST'
```
- JST日時を「YYYY年MM月DD日」形式で取得
- 仕様書の「最終更新」に使用

#### 1-2. テンプレートの読み込み
`.context/specs/templates/feature.template.md` を Read ツールで読み込み：
- 必須セクション、フォーマット、構造を把握
- プロジェクト固有のスタイルを理解

**または**、スクリプトでテンプレート一覧を取得：
```bash
tsx ./.claude/skills/spec-assistant/scripts/spec-list-templates.ts feature
```

#### 1-3. 既存仕様書の参照
`.context/specs/features/` から最新 3-5 件を Read ツールで読み込み：
- スタイル、詳細度、記述パターンを学習
- プロジェクト固有の書き方を把握

**または**、スクリプトで最新仕様書一覧を取得：
```bash
tsx ./.claude/skills/spec-assistant/scripts/spec-list-recent.ts 5 features
```

---

### 2. 対話フェーズ

#### 対話の柔軟性

**重要**: 以下のステップは推奨フローですが、ユーザーが既に十分な情報を提供している場合は該当ステップをスキップできます。

**例**:
- ユーザーが「通知機能の仕様書を作りたい。ユーザーが服薬時間になったらプッシュ通知を送る機能です」と詳細に説明した場合
  → 概要ステップをスキップし、不足情報のみ確認
- ユーザーが「この機能の仕様書を作りたい」とだけ言った場合
  → 全ステップを順番に実行

**判断基準**: ユーザーのメッセージから以下の情報が明確に読み取れる場合、該当ステップはスキップ可能
- 機能概要・目的
- ユースケース
- 主要な要件
- データモデル（該当する場合）

#### ステップ1: 機能概要のヒアリング

「この機能の目的と価値を教えてください」
- 何を実現する機能か
- ユーザーにどんな価値を提供するか

#### ステップ2: ユースケースの整理

「主要なユースケースを教えてください」
- どんなシナリオで使われるか
- 誰が（patient/supporter）どのように使うか

#### ステップ3: 機能要件の確認

「具体的にどんな機能が必要ですか？」
- 必須機能（優先度: 高）
- あると便利な機能（優先度: 中・低）

#### ステップ4: データモデルの設計

「新しいテーブルやフィールドが必要ですか？」
- 新規テーブル定義
- 既存テーブルへのフィールド追加
- インデックス設計

#### ステップ5: UI/UX要件の確認

「画面構成や操作フローはどうなりますか？」
- 画面構成
- インタラクション
- フィードバック

#### ステップ6: 権限設計（該当する場合）

「この機能にロール別の権限が必要ですか？」
- patient/supporter別の操作可否
- 条件付き権限

---

### 3. 生成フェーズ

収集した情報を `.context/specs/templates/feature.template.md` のフォーマットに基づいて構造化します。

#### ファイル名の決定

機能名から自動的に kebab-case 形式で生成：

**変換例**:
- 「通知機能」 → `notification.md`
- 「リマインダー設定」 → `reminder-settings.md`
- 「薬剤統計ダッシュボード」 → `medication-statistics-dashboard.md`

**命名ルール**:
- 英数字と `-` のみ使用
- すべて小文字
- スペースは `-` に変換
- 日本語は英訳してkebab-case化
- 略語は小文字に統一（例: `api`, `ui`）

**スクリプトで kebab-case 変換**:
```bash
tsx ./.claude/skills/spec-assistant/scripts/spec-to-kebab-case.ts "通知機能"
# 出力: notification
```

#### 実装状況の設定

各機能要件に「実装状況」を付与：
- **未実装**: これから実装する機能（実装前の仕様書作成）
- **進行中**: 現在開発中の機能
- **完了**: 既に実装済みの機能（実装後の仕様書作成）

#### 関連ドキュメントの自動提案

仕様書の内容から関連しそうなドキュメントを自動検索・提案：

**検索対象**:
- `.context/` 配下のプロジェクトドキュメント
- 既存の仕様書・決定記録
- アーキテクチャドキュメント

**提案ロジック**:
- 機能名のキーワードで検索
- 関連する技術スタック（Convex, Next.js等）
- データモデルで使用するテーブル

**スクリプトで関連ドキュメント検索**:
```bash
tsx ./.claude/skills/spec-assistant/scripts/spec-search-related.ts notification medication
```

---

### 4. バリデーションフェーズ

生成した仕様書が以下の基準を満たしているか確認：

#### 必須項目チェックリスト

- [ ] **タイトル**: 機能名が簡潔に表現されているか
- [ ] **最終更新**: YYYY年MM月DD日形式で正しく記載されているか
- [ ] **概要**: 機能の目的と価値提案が2-3文で記述されているか
- [ ] **ユースケース**: 主要シナリオが最低1つ以上記載されているか
- [ ] **機能要件**: カテゴリ別に整理され、優先度・実装状況が記載されているか
- [ ] **データモデル**: TypeScript形式でテーブル定義が記述されているか
- [ ] **UI/UX要件**: 画面構成とインタラクションが記載されているか

#### 品質基準チェック

- [ ] **具体性**: 抽象的な表現ではなく、具体的な実装方法が記載されているか
- [ ] **実装可能性**: 開発者がこの仕様書から実装を開始できるか
- [ ] **一貫性**: 既存の仕様書と矛盾していないか
- [ ] **完全性**: 他のチームメンバーが追加の質問なしで理解できるか

#### 自動チェック項目

- [ ] ファイル名: `[feature-name].md` 形式
- [ ] ファイルパス: `.context/specs/features/` 配下
- [ ] 文字エンコーディング: UTF-8
- [ ] 改行コード: LF（Unix形式）

**スクリプトで検証**:
```bash
tsx ./.claude/skills/spec-assistant/scripts/spec-validate.ts .context/specs/features/notification.md
```

---

### 5. 出力フェーズ

`.context/specs/features/[feature-name].md` に Write ツールで保存し、ユーザーに確認を促します。

---

## 生成される仕様書の構成

プロジェクトのテンプレート（`.context/specs/templates/feature.template.md`）に準拠して生成：

**主要セクション**:
- **概要**（目的と価値提案）
- **ユースケース**（主要シナリオ）
- **機能要件**（カテゴリ別、優先度・実装状況付き）
- **データモデル**（テーブル定義、ER図）
- **ビジネスルール**
- **権限設計**（RBAC）
- **API設計**（概要、詳細は別ファイル）
- **UI/UX要件**（画面構成、インタラクション）
- **バリデーション**（フロントエンド・バックエンド）
- **エラーハンドリング**
- **セキュリティ要件**
- **パフォーマンス要件**
- **テスト要件**
- **依存関係**
- **マイルストーン**
- **既知の課題**
- **関連ドキュメント**

詳細な構造は `.context/specs/templates/feature.template.md` を参照してください。

---

## 参照リソース

### 既存仕様書（学習材料）

`.context/specs/features/` 内の既存仕様書を参照し、スタイル・構造・詳細度を学習：
- `medication.md` - 服薬管理機能
- `group.md` - グループ管理機能
- `auth.md` - 認証機能
- `onboarding.md` - オンボーディング機能
- `medication-history.md` - 服薬履歴機能

### プロジェクトドキュメント

仕様書作成時に参照すべきドキュメント：
- `.context/project.md` - プロジェクト概要、技術スタック
- `.context/architecture.md` - アーキテクチャ全体像、データモデル
- `.context/coding-style.md` - コーディング規約（API設計パターン）
- `.context/error-handling.md` - エラーハンドリング戦略
- `.context/testing-strategy.md` - テスト戦略

---

## 注意事項

1. **実装との同期**: 仕様書と実装は常に同期すること（CLAUDE.mdの重要ルール）
2. **テンプレート準拠**: プロジェクト固有のテンプレートに100%準拠
3. **具体性**: 抽象的な記述ではなく、具体的な実装に言及
4. **実装可能性**: 開発者がこの仕様書から実装を開始できる詳細度
5. **日本語**: すべて日本語で記述（コードを除く）
