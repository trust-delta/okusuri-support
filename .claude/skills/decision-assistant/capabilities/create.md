# 新規決定記録の作成

技術的決定を対話形式で構造化して記録します。

## 実行フロー

### 1. 初期化フェーズ

#### 1-1. 現在日時の取得
```bash
./.claude/skills/decision-assistant/scripts/get-date.sh
```
- JST日付を YYYY-MM-DD 形式で取得
- ファイル名に使用（例: `2025-11-16`）

#### 1-2. テンプレートの読み込み
`.context/decisions/templates/decision-template.md` を Read ツールで読み込み：
- 必須セクション、フォーマット、構造を把握
- プロジェクト固有のスタイルを理解

#### 1-3. 既存決定記録の参照
`.context/decisions/` から最新 3-5 件を Read ツールで読み込み：
- スタイル、詳細度、記述パターンを学習
- プロジェクト特有の用語や表現を把握

#### 1-4. 矛盾・関連チェック（該当する場合のみ）

決定内容のキーワードを使用して、以下のスクリプトを実行：

**a) 競合検出**
```bash
tsx ./.claude/skills/decision-assistant/scripts/find-conflicts.ts <keyword1> <keyword2> ...
```
- ステータスが「承認済み」「実装完了」の決定との競合を検出
- 同一カテゴリでの相反する決定を特定
- リスクレベル（1-3）で優先順位付け

**b) 関連決定の発見**
```bash
tsx ./.claude/skills/decision-assistant/scripts/find-related.ts <keyword1> <keyword2> ...
```
- 同じカテゴリ・技術スタックの決定を検索
- 関連度スコアで優先順位付け
- 過去の知見・文脈を把握

**c) キーワード検索**
```bash
tsx ./.claude/skills/decision-assistant/scripts/search-decisions.ts <keyword1> <keyword2> ...
```
- タイトル・本文からキーワード検索
- マッチスコアで優先順位付け
- 重複チェック

**矛盾が見つかった場合の対応**:
- ユーザーに以下を確認：
  - 既存決定の変更・廃止が必要か
  - 新しい決定が既存決定の例外として扱われるか
  - 矛盾を解消する方法

**矛盾の例**:
- 既存: 「認証にClerkを使用」 → 新規: 「Convex Authに移行」（変更が必要）
- 既存: 「TypeScriptの厳格モードを使用」 → 新規: 「any型の使用を許可」（矛盾を指摘）

---

### 2. 対話フェーズ

#### 対話の柔軟性

**重要**: 以下の5ステップは推奨フローですが、ユーザーが既に十分な情報を提供している場合は該当ステップをスキップできます。

**例**:
- ユーザーが「Next.js 15に移行します。理由は...、代替案として...を検討しましたが...」と詳細に説明した場合
  → ステップ2-4をスキップし、不足情報のみ確認
- ユーザーが「この技術選定を記録したい」とだけ言った場合
  → 全ステップを順番に実行

**判断基準**: ユーザーのメッセージから以下の情報が明確に読み取れる場合、該当ステップはスキップ可能
- 背景・問題点
- 決定内容
- 理由
- 代替案（最低2つ）
- リスク・影響範囲

#### ステップ1: 背景のヒアリング

「どのような背景でこの決定が必要になりましたか？」
- 現状の問題点
- なぜ今決定する必要があるのか
- 関連する文脈

#### ステップ2: 決定内容の確認

「具体的にどのような決定を行いますか？」
- 採用する解決策
- 主要な決定事項

#### ステップ3: 理由の整理

「この決定を選択した理由を教えてください」
- なぜこの案が最適なのか
- 技術的根拠
- ビジネス的根拠

#### ステップ4: 代替案の検討

「他に検討した代替案はありますか？」
- 少なくとも2-3の代替案
- 各案のメリット・デメリット
- 却下理由

#### ステップ5: リスクと影響の確認

「実装上のリスクや影響範囲はありますか？」
- 技術的考慮事項
- 影響を受けるコンポーネント
- リスクと軽減策

---

### 3. 生成フェーズ

収集した情報を `.context/decisions/templates/decision-template.md` のフォーマットに基づいて構造化します。

#### ステータスの初期設定

決定記録のステータスは以下のルールで自動設定：

**デフォルト: `提案中`**
- これから検討・承認を受ける必要がある決定

**`承認済み` で作成する条件**:
- ユーザーが明示的に「決定した」「採用する」と述べた
- 実装が既に開始または完了している
- チーム内で合意が取れていることが明確

**`却下` で作成する条件**:
- 「この案は採用しない」という記録を残す場合
- 過去に検討したが却下された決定を記録する場合

**`廃止` で作成する条件**:
- 既存の決定を無効化する場合（ほぼ使用しない）

ステータスが不明確な場合、ユーザーに確認します。

#### 関連ドキュメントの自動提案

決定内容から関連しそうなドキュメントを自動的に検索・提案：

**検索対象**:
- `.context/` 配下のプロジェクトドキュメント（project.md, architecture.md, 仕様書など）
- 既存の決定記録（関連トピック）
- README、パッケージ設定ファイル

**提案ロジック**:
- 決定内容のキーワード（技術名、機能名）で検索
- 既存決定記録のタグ・カテゴリと照合
- 影響を受けるコンポーネント・モジュールから関連ファイルを特定

**例**:
- 「認証方式の変更」 → `.context/architecture.md`（認証フロー）、既存の認証関連決定
- 「UIライブラリ選定」 → `.context/project.md`（技術スタック）、`package.json`

---

### 4. バリデーションフェーズ

生成した決定記録が以下の基準を満たしているか確認：

#### 必須項目チェックリスト

- [ ] **タイトル**: 決定内容を簡潔に表現しているか
- [ ] **日付**: YYYY-MM-DD形式で正しく記載されているか
- [ ] **ステータス**: `承認済み`/`提案中`/`却下`/`廃止`のいずれかが設定されているか
- [ ] **決定者**: 誰が決定したか明記されているか
- [ ] **背景**: 問題点と文脈が具体的に説明されているか
- [ ] **決定**: 採用する解決策が明確に記述されているか
- [ ] **理由**: なぜこの決定を選択したか、技術的/ビジネス的根拠が記載されているか
- [ ] **利点**: 最低2つ以上、✅ マークで列挙されているか
- [ ] **欠点と対応策**: 各デメリット（❌）に対応する対応策が記載されているか
- [ ] **代替案**: 最低2つ以上の代替案と却下理由が記載されているか

#### 品質基準チェック

- [ ] **具体性**: 抽象的な表現ではなく、具体的な技術名・実装方法が記載されているか
- [ ] **将来の理解可能性**: 数ヶ月後に読んでも文脈を理解できるか
- [ ] **一貫性**: 既存の決定記録と矛盾していないか
- [ ] **完全性**: 他のチームメンバーが追加の質問なしで理解できるか

#### 自動チェック項目

- [ ] ファイル名: `YYYY-MM-DD-[kebab-case-topic].md` 形式
- [ ] ファイルパス: `.context/decisions/` 直下
- [ ] 文字エンコーディング: UTF-8
- [ ] 改行コード: LF（Unix形式）

チェックで問題が見つかった場合、修正してから保存します。

---

### 5. 出力フェーズ

`.context/decisions/YYYY-MM-DD-[topic].md` に Write ツールで保存し、ユーザーに確認を促します。

---

## トピック名の決定ルール

決定内容から自動的に kebab-case 形式で生成します。

### 変換例

- 「Next.js 15への移行」 → `nextjs-15-migration`
- 「認証方式の変更」 → `authentication-method-change`
- 「フォーム管理ライブラリの選定」 → `form-library-selection`
- 「グループ削除機能の実装」 → `group-delete-implementation`
- 「pnpmへの移行」 → `migrate-to-pnpm`

### 命名ルール

- 英数字と `-` のみ使用
- すべて小文字
- スペースは `-` に変換
- 日本語は英訳してkebab-case化
- 略語は小文字に統一（例: `nextjs`, `pnpm`）
- **動詞を含める**（例: `migrate-to-pnpm`, `adopt-react-hook-form`, `implement-group-delete`）
- **バージョン番号は含めない**（詳細は決定記録本文に記載）
  - ❌ `migrate-to-nextjs-15`
  - ✅ `migrate-to-nextjs`（本文で「Next.js 15への移行」と記載）
- **実装詳細ではなく決定の本質を表現**
  - ❌ `use-axios-for-http-requests`（実装詳細）
  - ✅ `http-client-selection`（決定の本質）
  - ❌ `add-loading-spinner-component`（実装詳細）
  - ✅ `loading-state-design`（決定の本質）

### 動詞の使い分け

- `migrate-to-*`: 既存技術から新技術への移行
- `adopt-*`: 新しい技術・ライブラリの導入
- `implement-*`: 機能・パターンの実装方針
- `change-*`: 既存の方針・設定の変更
- `remove-*`: 既存機能・依存の削除
- `*-selection`: 複数の選択肢からの選定

トピック名が適切でない場合、ユーザーに確認を求めることができます。

---

## 生成される決定記録の構成

プロジェクトのテンプレート（`.context/decisions/templates/decision-template.md`）に準拠して決定記録を生成します。

**主要セクション**:
- タイトル、日付、ステータス、決定者
- 背景（問題点と文脈）
- 決定（採用する解決策）
- 理由（なぜこの決定を選択したか）
- 利点（✅ で列挙）
- 欠点と対応策（❌ デメリット → 対応策）
- 代替案（却下理由を明記）
- 実装計画（技術的決定の場合）
- 関連ドキュメント
- 承認テーブル
- 更新履歴

詳細な構造は `.context/decisions/templates/decision-template.md` を参照してください。

---

## 参照リソース

### 既存決定記録（学習材料）

`.context/decisions/` 内の既存記録を参照し、スタイル・構造・詳細度を学習：
- `2025-10-26-medication-statistics.md` - 服薬統計機能の実装
- `2025-10-26-prescription-management.md` - 処方箋管理機能の導入
- `2025-10-26-group-leave-delete.md` - グループ脱退・削除機能
- `2025-10-26-migrate-to-pnpm.md` - pnpm移行
- `2025-10-16-context-driven-development.md` - コンテキスト駆動開発

### プロジェクトドキュメント

決定記録作成時に参照すべきドキュメント：
- `.context/project.md` - プロジェクト概要、技術スタック
- `.context/architecture.md` - アーキテクチャ全体像
- `.context/coding-style.md` - コーディング規約
- `.context/testing-strategy.md` - テスト戦略

---

## 注意事項

1. **既存決定の尊重**: 既存の決定記録と矛盾する場合は指摘する
2. **網羅的な検討**: 代替案は最低2つ以上提示する
3. **具体性**: 抽象的な記述ではなく、具体的な技術・実装に言及
4. **将来の自分への配慮**: 数ヶ月後に読んでも理解できる記述
5. **日本語**: すべて日本語で記述（コードを除く）
