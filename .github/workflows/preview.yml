name: Preview Deployment

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened]

jobs:
  preview-info:
    name: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: PR ã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v8
        with:
          script: |
            const body = `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤

            ã“ã®PRã®å¤‰æ›´ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ï¼š

            ### Vercel ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            Vercel ãŒè‡ªå‹•çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã¯ã“ã®PRã®ã‚³ãƒ¡ãƒ³ãƒˆã«è‡ªå‹•çš„ã«æŠ•ç¨¿ã•ã‚Œã¾ã™ã€‚

            ### Convex
            ç¾åœ¨ã€Convex ã¯æœ¬ç•ªç’°å¢ƒã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ã® Convex ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå¿…è¦ãªå ´åˆã¯ã€æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ---

            ğŸ“ **æ³¨æ„**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¯æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ··å…¥ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
            `;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
